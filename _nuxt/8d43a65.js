(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{1005:function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.normalizeGasFees=r.getEngineEvtContainer=void 0;const n=t(27),o=t(50),d=t(213);r.getEngineEvtContainer=()=>({[n.EngineEvents.IS_ALIVE]:d.Evt.create(),[n.EngineEvents.SETUP]:d.Evt.create(),[n.EngineEvents.CONDITIONAL_TRANSFER_CREATED]:d.Evt.create(),[n.EngineEvents.CONDITIONAL_TRANSFER_RESOLVED]:d.Evt.create(),[n.EngineEvents.DEPOSIT_RECONCILED]:d.Evt.create(),[n.EngineEvents.REQUEST_COLLATERAL]:d.Evt.create(),[n.EngineEvents.RESTORE_STATE_EVENT]:d.Evt.create(),[n.EngineEvents.WITHDRAWAL_CREATED]:d.Evt.create(),[n.EngineEvents.WITHDRAWAL_RESOLVED]:d.Evt.create(),[n.EngineEvents.WITHDRAWAL_RECONCILED]:d.Evt.create(),[n.TransactionEvents.TRANSACTION_SUBMITTED]:d.Evt.create(),[n.TransactionEvents.TRANSACTION_MINED]:d.Evt.create(),[n.TransactionEvents.TRANSACTION_FAILED]:d.Evt.create()}),r.normalizeGasFees=function(e,r,t,n,d,l,c,f){return o.normalizeFee(e,r,t,n,d,l,c,f)}},1068:function(e,r,t){"use strict";t.r(r),t.d(r,"AddressZero",(function(){return n})),t.d(r,"NegativeOne",(function(){return d})),t.d(r,"Zero",(function(){return l})),t.d(r,"One",(function(){return c})),t.d(r,"Two",(function(){return f})),t.d(r,"WeiPerEther",(function(){return h})),t.d(r,"MaxUint256",(function(){return m})),t.d(r,"HashZero",(function(){return v})),t.d(r,"EtherSymbol",(function(){return E}));const n="0x0000000000000000000000000000000000000000";var o=t(136);const d=o.a.from(-1),l=o.a.from(0),c=o.a.from(1),f=o.a.from(2),h=o.a.from("1000000000000000000"),m=o.a.from("0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"),v="0x0000000000000000000000000000000000000000000000000000000000000000",E="Îž"},1072:function(e,r,t){"use strict";t.r(r),t.d(r,"getAddress",(function(){return I})),t.d(r,"isAddress",(function(){return y})),t.d(r,"getIcapAddress",(function(){return A})),t.d(r,"getContractAddress",(function(){return R})),t.d(r,"getCreate2Address",(function(){return w}));var n=t(93),o=t(136),d=t(26),l=t(146);const c=new(t(2).b)("address/5.0.10");function f(address){Object(n.h)(address,20)||c.throwArgumentError("invalid address","address",address);const e=(address=address.toLowerCase()).substring(2).split(""),r=new Uint8Array(40);for(let i=0;i<40;i++)r[i]=e[i].charCodeAt(0);const t=Object(n.a)(Object(d.keccak256)(r));for(let i=0;i<40;i+=2)t[i>>1]>>4>=8&&(e[i]=e[i].toUpperCase()),(15&t[i>>1])>=8&&(e[i+1]=e[i+1].toUpperCase());return"0x"+e.join("")}const h={};for(let i=0;i<10;i++)h[String(i)]=String(i);for(let i=0;i<26;i++)h[String.fromCharCode(65+i)]=String(10+i);const m=Math.floor((v=9007199254740991,Math.log10?Math.log10(v):Math.log(v)/Math.LN10));var v;function E(address){let e=(address=(address=address.toUpperCase()).substring(4)+address.substring(0,2)+"00").split("").map((e=>h[e])).join("");for(;e.length>=m;){let r=e.substring(0,m);e=parseInt(r,10)%97+e.substring(r.length)}let r=String(98-parseInt(e,10)%97);for(;r.length<2;)r="0"+r;return r}function I(address){let e=null;if("string"!=typeof address&&c.throwArgumentError("invalid address","address",address),address.match(/^(0x)?[0-9a-fA-F]{40}$/))"0x"!==address.substring(0,2)&&(address="0x"+address),e=f(address),address.match(/([A-F].*[a-f])|([a-f].*[A-F])/)&&e!==address&&c.throwArgumentError("bad address checksum","address",address);else if(address.match(/^XE[0-9]{2}[0-9A-Za-z]{30,31}$/)){for(address.substring(2,4)!==E(address)&&c.throwArgumentError("bad icap checksum","address",address),e=Object(o.c)(address.substring(4));e.length<40;)e="0"+e;e=f("0x"+e)}else c.throwArgumentError("invalid address","address",address);return e}function y(address){try{return I(address),!0}catch(e){}return!1}function A(address){let e=Object(o.b)(I(address).substring(2)).toUpperCase();for(;e.length<30;)e="0"+e;return"XE"+E("XE00"+e)+e}function R(e){let r=null;try{r=I(e.from)}catch(r){c.throwArgumentError("missing from address","transaction",e)}const t=Object(n.i)(Object(n.a)(o.a.from(e.nonce).toHexString()));return I(Object(n.d)(Object(d.keccak256)(Object(l.encode)([r,t])),12))}function w(e,r,t){return 32!==Object(n.c)(r)&&c.throwArgumentError("salt must be 32 bytes","salt",r),32!==Object(n.c)(t)&&c.throwArgumentError("initCodeHash must be 32 bytes","initCodeHash",t),I(Object(n.d)(Object(d.keccak256)(Object(n.b)(["0xff",I(e),r,t])),12))}},135:function(e,r,t){"use strict";t.d(r,"d",(function(){return E})),t.d(r,"a",(function(){return y})),t.d(r,"c",(function(){return C})),t.d(r,"b",(function(){return T}));var n=t(14),o=t.n(n),d=t(1),l=t(2),c=t(513),f=o.a.BN;const h=new l.b(c.a),m={},v=9007199254740991;function E(e){return null!=e&&(y.isBigNumber(e)||"number"==typeof e&&e%1==0||"string"==typeof e&&!!e.match(/^-?[0-9]+$/)||Object(d.l)(e)||"bigint"==typeof e||Object(d.j)(e))}let I=!1;class y{constructor(e,r){h.checkNew(new.target,y),e!==m&&h.throwError("cannot call constructor directly; use BigNumber.from",l.b.errors.UNSUPPORTED_OPERATION,{operation:"new (BigNumber)"}),this._hex=r,this._isBigNumber=!0,Object.freeze(this)}fromTwos(e){return R(w(this).fromTwos(e))}toTwos(e){return R(w(this).toTwos(e))}abs(){return"-"===this._hex[0]?y.from(this._hex.substring(1)):this}add(e){return R(w(this).add(w(e)))}sub(e){return R(w(this).sub(w(e)))}div(e){return y.from(e).isZero()&&S("division by zero","div"),R(w(this).div(w(e)))}mul(e){return R(w(this).mul(w(e)))}mod(e){const r=w(e);return r.isNeg()&&S("cannot modulo negative values","mod"),R(w(this).umod(r))}pow(e){const r=w(e);return r.isNeg()&&S("cannot raise to negative values","pow"),R(w(this).pow(r))}and(e){const r=w(e);return(this.isNegative()||r.isNeg())&&S("cannot 'and' negative values","and"),R(w(this).and(r))}or(e){const r=w(e);return(this.isNegative()||r.isNeg())&&S("cannot 'or' negative values","or"),R(w(this).or(r))}xor(e){const r=w(e);return(this.isNegative()||r.isNeg())&&S("cannot 'xor' negative values","xor"),R(w(this).xor(r))}mask(e){return(this.isNegative()||e<0)&&S("cannot mask negative values","mask"),R(w(this).maskn(e))}shl(e){return(this.isNegative()||e<0)&&S("cannot shift negative values","shl"),R(w(this).shln(e))}shr(e){return(this.isNegative()||e<0)&&S("cannot shift negative values","shr"),R(w(this).shrn(e))}eq(e){return w(this).eq(w(e))}lt(e){return w(this).lt(w(e))}lte(e){return w(this).lte(w(e))}gt(e){return w(this).gt(w(e))}gte(e){return w(this).gte(w(e))}isNegative(){return"-"===this._hex[0]}isZero(){return w(this).isZero()}toNumber(){try{return w(this).toNumber()}catch(e){S("overflow","toNumber",this.toString())}return null}toString(){return arguments.length>0&&(10===arguments[0]?I||(I=!0,h.warn("BigNumber.toString does not accept any parameters; base-10 is assumed")):16===arguments[0]?h.throwError("BigNumber.toString does not accept any parameters; use bigNumber.toHexString()",l.b.errors.UNEXPECTED_ARGUMENT,{}):h.throwError("BigNumber.toString does not accept parameters",l.b.errors.UNEXPECTED_ARGUMENT,{})),w(this).toString(10)}toHexString(){return this._hex}toJSON(e){return{type:"BigNumber",hex:this.toHexString()}}static from(e){if(e instanceof y)return e;if("string"==typeof e)return e.match(/^-?0x[0-9a-f]+$/i)?new y(m,A(e)):e.match(/^-?[0-9]+$/)?new y(m,A(new f(e))):h.throwArgumentError("invalid BigNumber string","value",e);if("number"==typeof e)return e%1&&S("underflow","BigNumber.from",e),(e>=v||e<=-v)&&S("overflow","BigNumber.from",e),y.from(String(e));const r=e;if("bigint"==typeof r)return y.from(r.toString());if(Object(d.j)(r))return y.from(Object(d.i)(r));if(r)if(r.toHexString){const e=r.toHexString();if("string"==typeof e)return y.from(e)}else{let e=r._hex;if(null==e&&"BigNumber"===r.type&&(e=r.hex),"string"==typeof e&&(Object(d.l)(e)||"-"===e[0]&&Object(d.l)(e.substring(1))))return y.from(e)}return h.throwArgumentError("invalid BigNumber value","value",e)}static isBigNumber(e){return!(!e||!e._isBigNumber)}}function A(e){if("string"!=typeof e)return A(e.toString(16));if("-"===e[0])return"-"===(e=e.substring(1))[0]&&h.throwArgumentError("invalid hex","value",e),"0x00"===(e=A(e))?e:"-"+e;if("0x"!==e.substring(0,2)&&(e="0x"+e),"0x"===e)return"0x00";for(e.length%2&&(e="0x0"+e.substring(2));e.length>4&&"0x00"===e.substring(0,4);)e="0x"+e.substring(4);return e}function R(e){return y.from(A(e))}function w(e){const r=y.from(e).toHexString();return"-"===r[0]?new f("-"+r.substring(3),16):new f(r.substring(2),16)}function S(e,r,t){const n={fault:e,operation:r};return null!=t&&(n.value=t),h.throwError(e,l.b.errors.NUMERIC_FAULT,n)}function C(e){return new f(e,36).toString(16)}function T(e){return new f(e,16).toString(36)}},136:function(e,r,t){"use strict";t.d(r,"d",(function(){return E})),t.d(r,"a",(function(){return y})),t.d(r,"c",(function(){return C})),t.d(r,"b",(function(){return T}));var n=t(14),o=t.n(n),d=t(93),l=t(2),c=t(514),f=o.a.BN;const h=new l.b(c.a),m={},v=9007199254740991;function E(e){return null!=e&&(y.isBigNumber(e)||"number"==typeof e&&e%1==0||"string"==typeof e&&!!e.match(/^-?[0-9]+$/)||Object(d.h)(e)||"bigint"==typeof e||Object(d.g)(e))}let I=!1;class y{constructor(e,r){h.checkNew(new.target,y),e!==m&&h.throwError("cannot call constructor directly; use BigNumber.from",l.b.errors.UNSUPPORTED_OPERATION,{operation:"new (BigNumber)"}),this._hex=r,this._isBigNumber=!0,Object.freeze(this)}fromTwos(e){return R(w(this).fromTwos(e))}toTwos(e){return R(w(this).toTwos(e))}abs(){return"-"===this._hex[0]?y.from(this._hex.substring(1)):this}add(e){return R(w(this).add(w(e)))}sub(e){return R(w(this).sub(w(e)))}div(e){return y.from(e).isZero()&&S("division by zero","div"),R(w(this).div(w(e)))}mul(e){return R(w(this).mul(w(e)))}mod(e){const r=w(e);return r.isNeg()&&S("cannot modulo negative values","mod"),R(w(this).umod(r))}pow(e){const r=w(e);return r.isNeg()&&S("cannot raise to negative values","pow"),R(w(this).pow(r))}and(e){const r=w(e);return(this.isNegative()||r.isNeg())&&S("cannot 'and' negative values","and"),R(w(this).and(r))}or(e){const r=w(e);return(this.isNegative()||r.isNeg())&&S("cannot 'or' negative values","or"),R(w(this).or(r))}xor(e){const r=w(e);return(this.isNegative()||r.isNeg())&&S("cannot 'xor' negative values","xor"),R(w(this).xor(r))}mask(e){return(this.isNegative()||e<0)&&S("cannot mask negative values","mask"),R(w(this).maskn(e))}shl(e){return(this.isNegative()||e<0)&&S("cannot shift negative values","shl"),R(w(this).shln(e))}shr(e){return(this.isNegative()||e<0)&&S("cannot shift negative values","shr"),R(w(this).shrn(e))}eq(e){return w(this).eq(w(e))}lt(e){return w(this).lt(w(e))}lte(e){return w(this).lte(w(e))}gt(e){return w(this).gt(w(e))}gte(e){return w(this).gte(w(e))}isNegative(){return"-"===this._hex[0]}isZero(){return w(this).isZero()}toNumber(){try{return w(this).toNumber()}catch(e){S("overflow","toNumber",this.toString())}return null}toString(){return arguments.length>0&&(10===arguments[0]?I||(I=!0,h.warn("BigNumber.toString does not accept any parameters; base-10 is assumed")):16===arguments[0]?h.throwError("BigNumber.toString does not accept any parameters; use bigNumber.toHexString()",l.b.errors.UNEXPECTED_ARGUMENT,{}):h.throwError("BigNumber.toString does not accept parameters",l.b.errors.UNEXPECTED_ARGUMENT,{})),w(this).toString(10)}toHexString(){return this._hex}toJSON(e){return{type:"BigNumber",hex:this.toHexString()}}static from(e){if(e instanceof y)return e;if("string"==typeof e)return e.match(/^-?0x[0-9a-f]+$/i)?new y(m,A(e)):e.match(/^-?[0-9]+$/)?new y(m,A(new f(e))):h.throwArgumentError("invalid BigNumber string","value",e);if("number"==typeof e)return e%1&&S("underflow","BigNumber.from",e),(e>=v||e<=-v)&&S("overflow","BigNumber.from",e),y.from(String(e));const r=e;if("bigint"==typeof r)return y.from(r.toString());if(Object(d.g)(r))return y.from(Object(d.f)(r));if(r)if(r.toHexString){const e=r.toHexString();if("string"==typeof e)return y.from(e)}else{let e=r._hex;if(null==e&&"BigNumber"===r.type&&(e=r.hex),"string"==typeof e&&(Object(d.h)(e)||"-"===e[0]&&Object(d.h)(e.substring(1))))return y.from(e)}return h.throwArgumentError("invalid BigNumber value","value",e)}static isBigNumber(e){return!(!e||!e._isBigNumber)}}function A(e){if("string"!=typeof e)return A(e.toString(16));if("-"===e[0])return"-"===(e=e.substring(1))[0]&&h.throwArgumentError("invalid hex","value",e),"0x00"===(e=A(e))?e:"-"+e;if("0x"!==e.substring(0,2)&&(e="0x"+e),"0x"===e)return"0x00";for(e.length%2&&(e="0x0"+e.substring(2));e.length>4&&"0x00"===e.substring(0,4);)e="0x"+e.substring(4);return e}function R(e){return y.from(A(e))}function w(e){const r=y.from(e).toHexString();return"-"===r[0]?new f("-"+r.substring(3),16):new f(r.substring(2),16)}function S(e,r,t){const n={fault:e,operation:r};return null!=t&&(n.value=t),h.throwError(e,l.b.errors.NUMERIC_FAULT,n)}function C(e){return new f(e,36).toString(16)}function T(e){return new f(e,16).toString(36)}},2898:function(e,r,t){"use strict";var n=this&&this.__awaiter||function(e,r,t,n){return new(t||(t=Promise))((function(o,d){function l(e){try{f(n.next(e))}catch(e){d(e)}}function c(e){try{f(n.throw(e))}catch(e){d(e)}}function f(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(l,c)}f((n=n.apply(e,r||[])).next())}))},o=this&&this.__rest||function(s,e){var r={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(r[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(r[p[i]]=s[p[i]])}return r},d=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.VectorEngine=r.ajv=void 0;const l=t(2899),c=t(27),f=t(50),h=d(t(629)),m=t(2903),v=t(641),E=t(2904),I=t(2905),y=t(1005),A=t(2906);r.ajv=new h.default;class R{constructor(e,r,t,n,o,d,l,c){this.signer=e,this.messaging=r,this.store=t,this.vector=n,this.chainService=o,this.chainAddresses=d,this.lockService=l,this.logger=c,this.evts=y.getEngineEvtContainer(),this.restoreLocks={}}static connect(e,r,t,o,d,c,f,h,m,v){return n(this,void 0,void 0,(function*(){const n=yield l.Vector.connect(e,r,t,o,d,f.child({module:"VectorProtocol"}),h,v),E=new R(o,e,t,n,d,c,r,f.child({module:"VectorEngine"}));return yield E.setupListener(m),f.debug({},"Setup engine listeners"),h?f.warn("Skipping isAlive broadcast because of skipCheckIn config"):A.sendIsAlive(E.signer,E.messaging,E.store,E.chainService,E.logger),f.info({vector:n.publicIdentifier},"Vector Engine connected ðŸš€!"),E}))}get publicIdentifier(){return this.vector.publicIdentifier}get signerAddress(){return this.vector.signerAddress}setupListener(e){return n(this,void 0,void 0,(function*(){yield I.setupEngineListeners(this.evts,this.chainService,this.vector,this.messaging,this.signer,this.store,this.chainAddresses,this.logger,this.setup.bind(this),this.acquireRestoreLocks.bind(this),this.releaseRestoreLocks.bind(this),e)}))}acquireRestoreLocks(e){return n(this,void 0,void 0,(function*(){if(this.restoreLocks[e.channelAddress])return c.Result.ok(this.restoreLocks[e.channelAddress]);try{const r=e.alice===this.signer.address,t=yield this.lockService.acquireLock(e.channelAddress,r,r?e.bobIdentifier:e.aliceIdentifier);return this.restoreLocks[e.channelAddress]=t,c.Result.ok(void 0)}catch(r){return c.Result.fail(new v.RestoreError(v.RestoreError.reasons.AcquireLockError,e.channelAddress,this.signer.publicIdentifier,{acquireRestoreLockError:r.message}))}}))}releaseRestoreLocks(e){return n(this,void 0,void 0,(function*(){if(!this.restoreLocks[e.channelAddress])return c.Result.ok(void 0);try{const r=e.alice===this.signer.address;return yield this.lockService.releaseLock(e.channelAddress,this.restoreLocks[e.channelAddress],r,r?e.bobIdentifier:e.aliceIdentifier),delete this.restoreLocks[e.channelAddress],c.Result.ok(void 0)}catch(r){return c.Result.fail(new v.RestoreError(v.RestoreError.reasons.ReleaseLockError,e.channelAddress,this.signer.publicIdentifier,{releaseRestoreLockError:r.message}))}}))}getConfig(){return n(this,void 0,void 0,(function*(){return c.Result.ok([{index:0,publicIdentifier:this.publicIdentifier,signerAddress:this.signerAddress,chainAddresses:this.chainAddresses}])}))}getTransferQuote(e){var t;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.GetTransferQuoteSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=n.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}));const{routerIdentifier:d}=e,l=o(e,["routerIdentifier"]);return this.messaging.sendTransferQuoteMessage(c.Result.ok(l),d,this.publicIdentifier)}))}getWithdrawalQuote(e){var t;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.GetWithdrawalQuoteSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=n.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}));const o=yield this.getChannelState({channelAddress:e.channelAddress});if(o.isError)return c.Result.fail(o.getError());const d=o.getValue();if(!d)return c.Result.fail(new v.RpcError(v.RpcError.reasons.ChannelNotFound,e.channelAddress,this.publicIdentifier));if(this.publicIdentifier===d.aliceIdentifier)try{const r={channelAddress:e.channelAddress,amount:e.amount,assetId:e.assetId,fee:"0",expiry:(Date.now()+3e4).toString()},t=yield this.signer.signMessage(f.hashWithdrawalQuote(r));return c.Result.ok(Object.assign(Object.assign({},r),{signature:t}))}catch(r){return c.Result.fail(new v.RpcError(v.RpcError.reasons.SigningFailed,e.channelAddress,this.publicIdentifier,{signingError:c.jsonifyError(r)}))}return this.messaging.sendWithdrawalQuoteMessage(c.Result.ok(e),d.aliceIdentifier,this.publicIdentifier)}))}getRouterConfig(e){var t;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.GetRouterConfigSchema);return n(e)?this.messaging.sendRouterConfigMessage(c.Result.ok(void 0),e.routerIdentifier,this.publicIdentifier):c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=n.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}))}))}getStatus(){return n(this,void 0,void 0,(function*(){const e=Object.keys(this.chainAddresses).map((e=>parseInt(e))),r=yield Promise.all(e.map((e=>this.chainService.getSyncing(e)))),t=Object.fromEntries(e.map(((e,t)=>{var n;const o=r[t];let d;return d=o.isError?null===(n=o.getError())||void 0===n?void 0:n.message:o.getValue(),[e,d]})));return c.Result.ok({version:m.version,publicIdentifier:this.publicIdentifier,signerAddress:this.signerAddress,providerSyncing:t})}))}getChannelState(e){var t,o;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.GetChannelStateSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,null!==(t=e.channelAddress)&&void 0!==t?t:"",this.publicIdentifier,{invalidParamsError:null===(o=n.errors)||void 0===o?void 0:o.map((e=>e.message)).join(","),invalidParams:e}));try{const r=yield this.store.getChannelState(e.channelAddress);return c.Result.ok(r)}catch(r){return c.Result.fail(new v.RpcError(v.RpcError.reasons.StoreMethodFailed,e.channelAddress,this.publicIdentifier,{storeMethod:"getChannelState",storeError:r.message,params:e}))}}))}getTransferState(e){var t;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.GetTransferStateSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=n.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}));try{const r=yield this.store.getTransferState(e.transferId);return c.Result.ok(r)}catch(r){return c.Result.fail(new v.RpcError(v.RpcError.reasons.StoreMethodFailed,"",this.publicIdentifier,{storeMethod:"getTransferState",storeError:r.message,params:e}))}}))}getActiveTransfers(e){var t,o;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.GetActiveTransfersSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,null!==(t=e.channelAddress)&&void 0!==t?t:"",this.publicIdentifier,{invalidParamsError:null===(o=n.errors)||void 0===o?void 0:o.map((e=>e.message)).join(","),invalidParams:e}));try{const r=yield this.store.getActiveTransfers(e.channelAddress);return c.Result.ok(r)}catch(r){return c.Result.fail(new v.RpcError(v.RpcError.reasons.StoreMethodFailed,e.channelAddress,this.publicIdentifier,{storeMethod:"getActiveTransfers",storeError:r.message}))}}))}getTransfers(e){var t;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.GetTransfersSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=n.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}));try{const r=yield this.store.getTransfers(e);return c.Result.ok(r)}catch(e){return c.Result.fail(new v.RpcError(v.RpcError.reasons.StoreMethodFailed,"",this.publicIdentifier,{storeMethod:"getTransfers",storeError:e.message}))}}))}getTransferStateByRoutingId(e){var t,o,d;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.GetTransferStateByRoutingIdSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,null!==(t=e.channelAddress)&&void 0!==t?t:"",this.publicIdentifier,{invalidParamsError:null===(o=n.errors)||void 0===o?void 0:o.map((e=>e.message)).join(","),invalidParams:e}));try{const r=yield this.store.getTransferByRoutingId(e.channelAddress,e.routingId);return c.Result.ok(r)}catch(r){return c.Result.fail(new v.RpcError(v.RpcError.reasons.StoreMethodFailed,null!==(d=e.channelAddress)&&void 0!==d?d:"",this.publicIdentifier,{storeMethod:"getTransferByRoutingId",storeError:r.message}))}}))}getTransferStatesByRoutingId(e){var t;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.GetTransferStatesByRoutingIdSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=n.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}));try{const r=yield this.store.getTransfersByRoutingId(e.routingId);return c.Result.ok(r)}catch(e){return c.Result.fail(new v.RpcError(v.RpcError.reasons.StoreMethodFailed,"",this.publicIdentifier,{storeMethod:"getTransfersByRoutingId",storeError:e.message}))}}))}getChannelStateByParticipants(e){var t;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.GetChannelStateByParticipantsSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=n.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}));try{const r=yield this.store.getChannelStateByParticipants(e.alice,e.bob,e.chainId);return c.Result.ok(r)}catch(r){return c.Result.fail(new v.RpcError(v.RpcError.reasons.StoreMethodFailed,"",this.publicIdentifier,{storeMethod:"getChannelStateByParticipants",storeError:r.message,params:e}))}}))}getChannelStates(){return n(this,void 0,void 0,(function*(){try{const e=yield this.store.getChannelStates();return c.Result.ok(e)}catch(e){return c.Result.fail(new v.RpcError(v.RpcError.reasons.StoreMethodFailed,"",this.publicIdentifier,{storeMethod:"getChannelStates",storeError:e.message}))}}))}getRegisteredTransfers(e){var t;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.GetRegisteredTransfersSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=n.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}));const{chainId:o}=e;return yield this.chainService.getRegisteredTransfers(this.chainAddresses[o].transferRegistryAddress,o)}))}getWithdrawalCommitment(e){var t;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.GetWithdrawalCommitmentSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=n.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}));const{transferId:o}=e;try{const e=yield this.store.getWithdrawalCommitment(o);return c.Result.ok(e)}catch(e){return c.Result.fail(new v.RpcError(v.RpcError.reasons.StoreMethodFailed,"",this.publicIdentifier,{storeMethod:"getWithdrawalCommitment",error:c.jsonifyError(e)}))}}))}getWithdrawalCommitmentByTransactionHash(e){var t;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.GetWithdrawalCommitmentByTransactionHashSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=n.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}));const{transactionHash:o}=e;try{const e=yield this.store.getWithdrawalCommitmentByTransactionHash(o);return c.Result.ok(e)}catch(e){return c.Result.fail(new v.RpcError(v.RpcError.reasons.StoreMethodFailed,"",this.publicIdentifier,{storeMethod:"getWithdrawalCommitmentByTransactionHash",error:c.jsonifyError(e)}))}}))}setup(e){var t,o;return n(this,void 0,void 0,(function*(){const n="setup",d=f.getRandomBytes32();this.logger.info({params:e,method:n,methodId:d},"Method started");const l=r.ajv.compile(c.EngineParams.SetupSchema);if(!l(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=l.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}));const h=this.chainService.getChainProviders();if(h.isError)return c.Result.fail(h.getError());const m=yield E.convertSetupParams(e,this.chainAddresses);if(m.isError)return c.Result.fail(m.getError());const I=yield this.vector.setup(m.getValue());if(I.isError)return c.Result.fail(I.getError());const y=I.getValue();if(this.signerAddress===y.bob)return I;if(!c.AUTODEPLOY_CHAIN_IDS.includes(y.networkContext.chainId))return I;this.logger.info({method:n,chainId:y.networkContext.chainId,channel:y.channelAddress},"Deploying channel multisig");const A=yield this.chainService.getGasPrice(y.networkContext.chainId);A.isError&&c.Result.fail(A.getError());const R=A.getValue();this.logger.info({method:n,chainId:y.networkContext.chainId,channel:y.channelAddress},"Got gas price");const w=yield this.chainService.sendDeployChannelTx(y,R);if(w.isError){const e=w.getError();return this.logger.error(Object.assign(Object.assign({},null!==(o=null==e?void 0:e.context)&&void 0!==o?o:{}),{chainId:y.networkContext.chainId,channel:y.channelAddress,error:w.getError().message}),"Failed to deploy channel multisig"),I}const S=w.getValue();this.logger.info({chainId:y.networkContext.chainId,hash:S.hash},"Deploy tx broadcast");const C=yield S.completed();return C.isError?c.Result.fail(C.getError()):(this.logger.debug({chainId:y.networkContext.chainId,hash:S.hash},"Deploy tx mined"),this.logger.info({result:I.isError?c.jsonifyError(I.getError()):I.getValue(),method:n,methodId:d},"Method complete"),I)}))}requestSetup(e){var t;return n(this,void 0,void 0,(function*(){const n="requestSetup",o=f.getRandomBytes32();this.logger.info({params:e,method:n,methodId:o},"Method started");const d=r.ajv.compile(c.EngineParams.SetupSchema);if(!d(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=d.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}));const l=yield this.messaging.sendSetupMessage(c.Result.ok(e),e.counterpartyIdentifier,this.publicIdentifier);return this.logger.info({result:l.isError?c.jsonifyError(l.getError()):l.getValue(),method:n,methodId:o},"Method complete"),l}))}deposit(e){var t,o,d,l;return n(this,void 0,void 0,(function*(){const n="deposit",h=f.getRandomBytes32();this.logger.info({params:e,method:n,methodId:h},"Method started");const m=r.ajv.compile(c.EngineParams.DepositSchema);if(!m(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,null!==(t=e.channelAddress)&&void 0!==t?t:"",this.publicIdentifier,{invalidParamsError:null===(o=m.errors)||void 0===o?void 0:o.map((e=>e.message)).join(","),invalidParams:e}));let E=yield this.vector.deposit(e),I=1;for(const r of Array(3).fill(0)){if(!E.isError)break;const r=E.getError(),t="Could not recover signers";if(!(r.message===t||(null===(l=null===(d=r.context)||void 0===d?void 0:d.counterpartyError)||void 0===l?void 0:l.message)===t))break;this.logger.warn({attempt:I,channelAddress:e.channelAddress},"Retrying deposit reconciliation"),E=yield this.vector.deposit(e),I++}return this.logger.info({result:E.isError?c.jsonifyError(E.getError()):E.getValue(),method:n,methodId:h},"Method complete"),E}))}requestCollateral(e){var t,o;return n(this,void 0,void 0,(function*(){const n="requestCollateral",d=f.getRandomBytes32();this.logger.info({params:e,method:n,methodId:d},"Method started");const l=r.ajv.compile(c.EngineParams.RequestCollateralSchema);if(!l(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,null!==(t=e.channelAddress)&&void 0!==t?t:"",this.publicIdentifier,{invalidParamsError:null===(o=l.errors)||void 0===o?void 0:o.map((e=>e.message)).join(","),invalidParams:e}));const h=yield this.getChannelState({channelAddress:e.channelAddress});if(h.isError)return c.Result.fail(h.getError());const m=h.getValue();if(!m)return c.Result.fail(new v.RpcError(v.RpcError.reasons.ChannelNotFound,e.channelAddress,this.publicIdentifier));const E=f.getParticipant(m,this.publicIdentifier);if(!E)return c.Result.fail(new v.RpcError(v.RpcError.reasons.SignerNotInChannel,m.channelAddress,this.publicIdentifier,{alice:m.aliceIdentifier,bob:m.bobIdentifier,signer:this.publicIdentifier}));const I=yield this.messaging.sendRequestCollateralMessage(c.Result.ok(e),"alice"===E?m.bobIdentifier:m.aliceIdentifier,this.publicIdentifier);return this.logger.info({result:I.isError?c.jsonifyError(I.getError()):I.getValue(),method:n,methodId:d},"Method complete"),I}))}createTransfer(e){var t,o;return n(this,void 0,void 0,(function*(){const n="createTransfer",d=f.getRandomBytes32();this.logger.info({params:e,method:n,methodId:d},"Method started");const l=r.ajv.compile(c.EngineParams.ConditionalTransferSchema);if(!l(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,null!==(t=e.channelAddress)&&void 0!==t?t:"",this.publicIdentifier,{invalidParamsError:null===(o=l.errors)||void 0===o?void 0:o.map((e=>e.message)).join(","),invalidParams:e}));const h=yield this.getChannelState({channelAddress:e.channelAddress});if(h.isError)return c.Result.fail(h.getError());const m=h.getValue();if(!m)return c.Result.fail(new v.RpcError(v.RpcError.reasons.ChannelNotFound,e.channelAddress,this.publicIdentifier));this.logger.info({channel:m,method:n,methodId:d},"Pre-transfer channel");const I=yield E.convertConditionalTransferParams(e,this.signer,m,this.chainService,this.messaging);if(I.isError)return c.Result.fail(I.getError());const y=I.getValue();this.logger.info({transferParams:y,method:n,methodId:d},"Created conditional transfer params");const A=yield this.vector.create(y);if(A.isError)return c.Result.fail(A.getError());const R=A.getValue();return this.logger.info({channel:R,method:n,methodId:d},"Method complete"),c.Result.ok(R)}))}resolveTransfer(e){var t,o,d;return n(this,void 0,void 0,(function*(){const n="resolveTransfer",l=f.getRandomBytes32();this.logger.info({params:e,method:n,methodId:l},"Method started");const h=r.ajv.compile(c.EngineParams.ResolveTransferSchema);if(!h(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,null!==(t=e.channelAddress)&&void 0!==t?t:"",this.publicIdentifier,{invalidParamsError:null===(o=h.errors)||void 0===o?void 0:o.map((e=>e.message)).join(","),invalidParams:e}));const m=yield this.getTransferState({transferId:e.transferId});if(m.isError)return c.Result.fail(m.getError());const I=m.getValue();if(!I)return c.Result.fail(new v.RpcError(v.RpcError.reasons.TransferNotFound,null!==(d=e.channelAddress)&&void 0!==d?d:"",this.publicIdentifier,{transferId:e.transferId}));this.logger.info({transfer:I,method:n,methodId:l},"Transfer pre-resolve");const y=E.convertResolveConditionParams(e,I);if(y.isError)return c.Result.fail(y.getError());const A=y.getValue(),R=yield this.vector.resolve(A);if(R.isError)return c.Result.fail(R.getError());const w=R.getValue();return this.logger.info({channel:w,method:n,methodId:l},"Method complete"),c.Result.ok(w)}))}withdraw(e){var t,o,d;return n(this,void 0,void 0,(function*(){const n="withdraw",l=f.getRandomBytes32();this.logger.info({params:e,method:n,methodId:l},"Method started");const h=r.ajv.compile(c.EngineParams.WithdrawSchema);if(!h(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,null!==(t=e.channelAddress)&&void 0!==t?t:"",this.publicIdentifier,{invalidParamsError:null===(o=h.errors)||void 0===o?void 0:o.map((e=>e.message)).join(","),invalidParams:e}));const m=yield this.getChannelState({channelAddress:e.channelAddress});if(m.isError)return c.Result.fail(m.getError());const I=m.getValue();if(!I)return c.Result.fail(new v.RpcError(v.RpcError.reasons.ChannelNotFound,e.channelAddress,this.publicIdentifier));const y=yield E.convertWithdrawParams(e,this.signer,I,this.chainAddresses,this.chainService,this.messaging);if(y.isError)return c.Result.fail(y.getError());const A=y.getValue(),R=null!==(d=A.meta.initiatorSubmits)&&void 0!==d&&d,w=yield this.vector.create(A);if(w.isError)return c.Result.fail(w.getError());const S=w.getValue(),C=S.latestUpdate.details.transferId;let T,x;this.logger.info({channelAddress:e.channelAddress,transferId:C},"Withdraw transfer created");const U=9e4;try{const[r,t]=yield Promise.all([this.evts[c.WITHDRAWAL_RESOLVED_EVENT].attachOnce(U,(data=>data.channelAddress===e.channelAddress&&data.transfer.transferId===C)),this.evts[c.WITHDRAWAL_RECONCILED_EVENT].attachOnce(U,(data=>data.channelAddress===e.channelAddress&&data.transferId===C))]);T=t.transactionHash,x=r.transaction}catch(r){this.logger.warn({channelAddress:e.channelAddress,transferId:C,timeout:U,initiatorSubmits:R},"Withdraw tx not processed properly")}return this.logger.info({channel:S,method:n,methodId:l,transactionHash:T,transaction:x},"Method complete"),c.Result.ok({channel:S,transactionHash:T,transaction:x})}))}decrypt(e){return n(this,void 0,void 0,(function*(){const r="decrypt",t=f.getRandomBytes32();this.logger.info({encrypted:e,method:r,methodId:t},"Method started");try{const n=yield this.signer.decrypt(e);return this.logger.info({res:n,method:r,methodId:t},"Method complete"),c.Result.ok(n)}catch(e){return c.Result.fail(new v.RpcError(v.RpcError.reasons.DecryptFailed,"",this.publicIdentifier,{decryptError:e.message}))}}))}signUtilityMessage(e){var t;return n(this,void 0,void 0,(function*(){const n="signUtilityMessage",o=f.getRandomBytes32();this.logger.info({params:e,method:n,methodId:o},"Method started");const d=r.ajv.compile(c.EngineParams.SignUtilityMessageSchema);if(!d(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=d.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}));try{const r=yield this.signer.signUtilityMessage(e.message);return this.logger.info({sig:r,method:n,methodId:o},"Method complete"),c.Result.ok(r)}catch(e){return c.Result.fail(new v.RpcError(v.RpcError.reasons.UtilitySigningFailed,"",this.publicIdentifier,{signingError:e.message}))}}))}sendIsAlive(e){var t,o;return n(this,void 0,void 0,(function*(){const n="sendIsAlive",d=f.getRandomBytes32();this.logger.info({params:e,method:n,methodId:d},"Method started");const l=r.ajv.compile(c.EngineParams.SendIsAliveSchema);if(!l(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,null!==(t=e.channelAddress)&&void 0!==t?t:"",this.publicIdentifier,{invalidParamsError:null===(o=l.errors)||void 0===o?void 0:o.map((e=>e.message)).join(","),invalidParams:e}));try{const r=yield this.store.getChannelState(e.channelAddress);if(!r)return c.Result.fail(new v.IsAliveError(v.IsAliveError.reasons.ChannelNotFound,e.channelAddress,this.signer.publicIdentifier));const t=this.signer.address===r.alice?r.bobIdentifier:r.aliceIdentifier,o=yield this.messaging.sendIsAliveMessage(c.Result.ok(e),t,this.signer.publicIdentifier);return this.logger.info({result:o.isError?c.jsonifyError(o.getError()):o.getValue(),method:n,methodId:d},"Method complete"),o}catch(r){return c.Result.fail(new v.IsAliveError(v.IsAliveError.reasons.Unknown,e.channelAddress,this.signer.publicIdentifier,{isAliveError:r.message}))}}))}restoreState(e){var t,o,d,l;return n(this,void 0,void 0,(function*(){const h="restoreState",m=f.getRandomBytes32();this.logger.info({params:e,method:h,methodId:m},"Method started");const E=r.ajv.compile(c.EngineParams.RestoreStateSchema);if(!E(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=E.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}));const{chainId:I,counterpartyIdentifier:y}=e,A=yield this.messaging.sendRestoreStateMessage(c.Result.ok({chainId:I}),y,this.signer.publicIdentifier);if(A.isError)return c.Result.fail(A.getError());const{channel:R,activeTransfers:w}=null!==(o=A.getValue())&&void 0!==o?o:{},S=(r,t={})=>n(this,void 0,void 0,(function*(){var n;if(!r){const e=yield this.messaging.sendRestoreStateMessage(c.Result.ok({channelAddress:R.channelAddress}),y,this.signer.publicIdentifier);if(!e.isError)return c.Result.ok(R);r=v.RestoreError.reasons.AckFailed,t={error:c.jsonifyError(e.getError())}}const o=new v.RestoreError(r,null!==(n=null==R?void 0:R.channelAddress)&&void 0!==n?n:"",this.publicIdentifier,Object.assign(Object.assign({},t),{method:h,params:e}));return yield this.messaging.sendRestoreStateMessage(c.Result.fail(o),y,this.signer.publicIdentifier),c.Result.fail(o)}));if(!R||!w)return S(v.RestoreError.reasons.NoData);const C=f.getSignerAddressFromPublicIdentifier(y),T=yield this.chainService.getChannelAddress(R.alice===this.signer.address?this.signer.address:C,R.bob===this.signer.address?this.signer.address:C,R.networkContext.channelFactoryAddress,I);if(T.isError)return S(v.RestoreError.reasons.GetChannelAddressFailed,{getChannelAddressError:c.jsonifyError(T.getError())});if(T.getValue()!==R.channelAddress)return S(v.RestoreError.reasons.InvalidChannelAddress,{calculated:T.getValue()});const x=yield f.validateChannelUpdateSignatures(R,R.latestUpdate.aliceSignature,R.latestUpdate.bobSignature,"both");if(x.isError)return S(v.RestoreError.reasons.InvalidSignatures,{recoveryError:x.getError().message});const{root:U}=f.generateMerkleTreeData(w);if(U!==R.merkleRoot)return S(v.RestoreError.reasons.InvalidMerkleRoot,{calculated:U,merkleRoot:R.merkleRoot,activeTransfers:w.map((e=>e.transferId))});const N=yield this.getChannelState({channelAddress:R.channelAddress});if(N.isError)return S(v.RestoreError.reasons.CouldNotGetChannel,{getChannelStateError:c.jsonifyError(N.getError())});const O=null!==(l=null===(d=N.getValue())||void 0===d?void 0:d.nonce)&&void 0!==l?l:0;if(R.nonce-O<=1&&R.latestUpdate.type!==c.UpdateType.setup)return S(v.RestoreError.reasons.SyncableState,{existing:O,toRestore:R.nonce});try{yield this.store.saveChannelStateAndTransfers(R,w)}catch(e){return S(v.RestoreError.reasons.SaveChannelFailed,{saveChannelStateAndTransfersError:e.message})}const P=yield S();return this.evts[c.EngineEvents.RESTORE_STATE_EVENT].post({channelAddress:R.channelAddress,aliceIdentifier:R.aliceIdentifier,bobIdentifier:R.bobIdentifier,chainId:I}),this.logger.info({result:P.isError?c.jsonifyError(P.getError()):P.getValue(),method:h,methodId:m},"Method complete"),P}))}dispute(e){var t,o;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.DisputeChannelSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,null!==(t=e.channelAddress)&&void 0!==t?t:"",this.publicIdentifier,{invalidParamsError:null===(o=n.errors)||void 0===o?void 0:o.map((e=>e.message)).join(","),invalidParams:e}));const d=yield this.getChannelState({channelAddress:e.channelAddress});if(d.isError)return c.Result.fail(d.getError());const l=d.getValue();if(!l)return c.Result.fail(new v.DisputeError(v.DisputeError.reasons.ChannelNotFound,e.channelAddress,this.publicIdentifier));const f=yield this.chainService.sendDisputeChannelTx(l);return f.isError?c.Result.fail(f.getError()):c.Result.ok({transactionHash:f.getValue().hash})}))}defund(e){var t,o;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.DefundChannelSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,null!==(t=e.channelAddress)&&void 0!==t?t:"",this.publicIdentifier,{invalidParamsError:null===(o=n.errors)||void 0===o?void 0:o.map((e=>e.message)).join(","),invalidParams:e}));const d=yield this.getChannelState({channelAddress:e.channelAddress});if(d.isError)return c.Result.fail(d.getError());const l=d.getValue();if(!l)return c.Result.fail(new v.DisputeError(v.DisputeError.reasons.ChannelNotFound,e.channelAddress,this.publicIdentifier));if(!l.inDispute)return c.Result.fail(new v.DisputeError(v.DisputeError.reasons.ChannelNotInDispute,e.channelAddress,this.publicIdentifier));const f=yield this.chainService.sendDefundChannelTx(l);return f.isError?c.Result.fail(f.getError()):c.Result.ok({transactionHash:f.getValue().hash})}))}disputeTransfer(e){var t;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.DisputeTransferSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=n.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}));const o=yield this.getTransferState(e);if(o.isError)return c.Result.fail(o.getError());const d=o.getValue();if(!d)return c.Result.fail(new v.DisputeError(v.DisputeError.reasons.TransferNotFound,"",this.publicIdentifier,{transferId:e.transferId}));const l=yield this.getActiveTransfers({channelAddress:d.channelAddress});if(l.isError)return c.Result.fail(l.getError());const f=yield this.chainService.sendDisputeTransferTx(d.transferId,l.getValue());return f.isError?c.Result.fail(f.getError()):c.Result.ok({transactionHash:f.getValue().hash})}))}defundTransfer(e){var t;return n(this,void 0,void 0,(function*(){const n=r.ajv.compile(c.EngineParams.DefundTransferSchema);if(!n(e))return c.Result.fail(new v.RpcError(v.RpcError.reasons.InvalidParams,"",this.publicIdentifier,{invalidParamsError:null===(t=n.errors)||void 0===t?void 0:t.map((e=>e.message)).join(","),invalidParams:e}));const o=yield this.getTransferState(e);if(o.isError)return c.Result.fail(o.getError());const d=o.getValue();if(!d)return c.Result.fail(new v.DisputeError(v.DisputeError.reasons.TransferNotFound,"",this.publicIdentifier,{transferId:e.transferId}));if(!d.inDispute)return c.Result.fail(new v.DisputeError(v.DisputeError.reasons.TransferNotDisputed,d.channelAddress,this.publicIdentifier,{transferId:d.transferId}));const l=yield this.chainService.sendDefundTransferTx(d);return l.isError?c.Result.fail(l.getError()):c.Result.ok({transactionHash:l.getValue().hash})}))}request(e){var t,o,d,l,f,h;return n(this,void 0,void 0,(function*(){this.logger.debug({payload:e,method:"request"},"Method called");const n=r.ajv.compile(c.EngineParams.RpcRequestSchema);if(!n(e))throw this.logger.error(Object.assign({method:"request",payload:e},null!==(t=n.errors)&&void 0!==t?t:{})),new v.RpcError(v.RpcError.reasons.InvalidRpcSchema,null!==(d=null===(o=e.params)||void 0===o?void 0:o.channelAddress)&&void 0!==d?d:"",this.publicIdentifier,{invalidRpcRequest:e,invalidRpcRequestError:null===(l=n.errors)||void 0===l?void 0:l.map((e=>e.message)).join(",")});const m=e.method.replace("chan_","");if("function"!=typeof this[m])throw new v.RpcError(v.RpcError.reasons.InvalidMethod,null!==(h=null===(f=e.params)||void 0===f?void 0:f.channelAddress)&&void 0!==h?h:"",this.publicIdentifier,{payload:e});const E=yield this[m](e.params);if(E.isError)throw E.getError();return E.getValue()}))}on(e,r,filter=(()=>!0)){this.evts[e].pipe(filter).attach(r)}once(e,r,filter=(()=>!0)){this.evts[e].pipe(filter).attachOnce(r)}waitFor(e,r,filter=(()=>!0)){return this.evts[e].pipe(filter).waitFor(r)}off(e){e?this.evts[e].detach():Object.keys(c.EngineEvents).forEach((e=>this.evts[e].detach()))}}r.VectorEngine=R},2899:function(e,r,t){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,r,t,n){void 0===n&&(n=t),Object.defineProperty(e,n,{enumerable:!0,get:function(){return r[t]}})}:function(e,r,t,n){void 0===n&&(n=t),e[n]=r[t]}),o=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),d=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&n(r,e,t);return o(r,e),r},l=this&&this.__awaiter||function(e,r,t,n){return new(t||(t=Promise))((function(o,d){function l(e){try{f(n.next(e))}catch(e){d(e)}}function c(e){try{f(n.throw(e))}catch(e){d(e)}}function f(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(l,c)}f((n=n.apply(e,r||[])).next())}))};Object.defineProperty(r,"__esModule",{value:!0}),r.Vector=void 0;const c=t(27),f=t(50),h=t(213),m=t(472),v=d(t(2900)),E=t(473);class I{constructor(e,r,t,n,o,d,l,f){this.messagingService=e,this.lockService=r,this.storeService=t,this.signer=n,this.chainReader=o,this.externalValidationService=d,this.logger=l,this.skipCheckIn=f,this.evts={[c.ProtocolEventName.CHANNEL_UPDATE_EVENT]:h.Evt.create()}}static connect(e,r,t,n,o,d,f,h){return l(this,void 0,void 0,(function*(){const l=null!=h?h:{validateOutbound:(e,r,t)=>Promise.resolve(c.Result.ok(void 0)),validateInbound:(e,r,t)=>Promise.resolve(c.Result.ok(void 0))},m=yield new I(e,r,t,n,o,l,d,f).setupServices();return d.info("Vector Protocol connected ðŸš€!"),m}))}get signerAddress(){return this.signer.address}get publicIdentifier(){return this.signer.publicIdentifier}lockedOperation(e){return l(this,void 0,void 0,(function*(){const r=yield v.outbound(e,this.storeService,this.chainReader,this.messagingService,this.externalValidationService,this.signer,this.logger);if(r.isError)return this.logger.error({method:"lockedOperation",variable:"outboundRes",error:c.jsonifyError(r.getError())}),r;const{updatedChannel:t,updatedTransfers:n,updatedTransfer:o}=r.getValue();return this.evts[c.ProtocolEventName.CHANNEL_UPDATE_EVENT].post({updatedChannelState:t,updatedTransfers:n,updatedTransfer:o}),c.Result.ok(r.getValue().updatedChannel)}))}executeUpdate(e){return l(this,void 0,void 0,(function*(){const r=f.getRandomBytes32();let t,n,o;if(this.logger.debug({method:"executeUpdate",methodId:r,step:"start",params:e,channelAddress:e.channelAddress,updateSender:this.publicIdentifier}),e.type===c.UpdateType.setup)t=this.publicIdentifier,n=e.details.counterpartyIdentifier;else{if(o=yield this.storeService.getChannelState(e.channelAddress),!o)return c.Result.fail(new m.OutboundChannelUpdateError(m.OutboundChannelUpdateError.reasons.ChannelNotFound,e));t=o.aliceIdentifier,n=o.bobIdentifier}const d=this.publicIdentifier===t,l=d?n:t;let h;try{h=yield this.lockService.acquireLock(e.channelAddress,d,l)}catch(r){return c.Result.fail(new m.OutboundChannelUpdateError(m.OutboundChannelUpdateError.reasons.AcquireLockFailed,e,o,{lockError:r.message}))}const v=yield this.lockedOperation(e);try{yield this.lockService.releaseLock(e.channelAddress,h,d,l)}catch(r){return c.Result.fail(new m.OutboundChannelUpdateError(m.OutboundChannelUpdateError.reasons.ReleaseLockFailed,e,o,{outboundResult:v.toJson(),lockError:c.jsonifyError(r)}))}return v}))}setupServices(){return l(this,void 0,void 0,(function*(){if(yield this.messagingService.onReceiveProtocolMessage(this.publicIdentifier,((e,r,t)=>l(this,void 0,void 0,(function*(){var n;if(r===this.publicIdentifier)return;const o="onReceiveProtocolMessage",d=f.getRandomBytes32();if(this.logger.debug({method:o,methodId:d},"Method start"),e.isError)return void this.logger.error({method:o,methodId:d,error:null===(n=e.getError())||void 0===n?void 0:n.toJson()},"Error received from counterparty's initial message, this shouldn't happen");const l=e.getValue(),h=Object.keys(l);if(!h.includes("update")||!h.includes("previousUpdate"))return void this.logger.warn({method:o,methodId:d,received:Object.keys(l)},"Message malformed");const m=this.validateParamSchema(l.update,c.TChannelUpdate);if(m)return void this.logger.warn({method:o,methodId:d,update:l.update,error:c.jsonifyError(m)},"Received malformed proposed update");const E=this.validateParamSchema(l.previousUpdate,c.TChannelUpdate);if(E&&l.previousUpdate)return void this.logger.warn({method:o,methodId:d,update:l.previousUpdate,error:c.jsonifyError(E)},"Received malformed previous update");if(l.update.fromIdentifier===this.publicIdentifier)return void this.logger.debug({method:o,methodId:d},"Received update from ourselves, doing nothing");const I=yield v.inbound(l.update,l.previousUpdate,t,this.chainReader,this.storeService,this.messagingService,this.externalValidationService,this.signer,this.logger);if(I.isError)return void this.logger.warn({method:o,methodId:d,error:c.jsonifyError(I.getError())},"Failed to apply inbound update");const{updatedChannel:y,updatedActiveTransfers:A,updatedTransfer:R}=I.getValue();this.evts[c.ProtocolEventName.CHANNEL_UPDATE_EVENT].post({updatedChannelState:y,updatedTransfers:A,updatedTransfer:R}),this.logger.debug({method:o,methodId:d},"Method complete")})))),this.skipCheckIn)this.logger.warn("Skipping checking disputes because of skipCheckIn config");else{const e=yield this.storeService.getChannelStates(),r=this.chainReader.getChainProviders();if(r.isError)return this.logger.error(Object.assign({},r.getError()),"Error getting chain providers"),this;const t=Object.keys(r.getValue()).map((e=>parseInt(e)));yield Promise.all(e.map((e=>l(this,void 0,void 0,(function*(){if(!t.includes(e.networkContext.chainId))return void this.logger.debug({chainId:e.networkContext.chainId,supportedChains:t},"Channel chain not supported, skipping");const r=yield this.chainReader.getChannelDispute(e.channelAddress,e.networkContext.chainId);if(r.isError)return void this.logger.error({channelAddress:e.channelAddress,error:r.getError().message},"Could not get dispute");const n=r.getValue();if(n)try{yield this.storeService.saveChannelDispute(Object.assign(Object.assign({},e),{inDispute:!0}),n)}catch(r){this.logger.error({channelAddress:e.channelAddress,error:r.message},"Failed to update dispute on startup")}})))))}return this}))}validateParamSchema(e,r){const t=E.validateSchema(e,r);if(t)return new m.OutboundChannelUpdateError(m.OutboundChannelUpdateError.reasons.InvalidParams,e,void 0,{paramsError:t})}setup(e){var r;return l(this,void 0,void 0,(function*(){const t="setup",n=f.getRandomBytes32();this.logger.debug({method:t,methodId:n},"Method start");const o=this.validateParamSchema(e,c.ProtocolParams.SetupSchema);if(o)return this.logger.error({method:t,methodId:n,params:e,error:c.jsonifyError(o)}),c.Result.fail(o);const d=yield f.getCreate2MultisigAddress(this.publicIdentifier,e.counterpartyIdentifier,e.networkContext.chainId,e.networkContext.channelFactoryAddress,this.chainReader);if(d.isError)return c.Result.fail(new m.OutboundChannelUpdateError(m.OutboundChannelUpdateError.reasons.Create2Failed,{details:e,channelAddress:"",type:c.UpdateType.setup},void 0,{create2Error:null===(r=d.getError())||void 0===r?void 0:r.message}));const l={channelAddress:d.getValue(),details:e,type:c.UpdateType.setup},h=yield this.executeUpdate(l);return this.logger.debug({result:h.isError?c.jsonifyError(h.getError()):h.getValue(),method:t,methodId:n},"Method complete"),h}))}deposit(e){return l(this,void 0,void 0,(function*(){const r="deposit",t=f.getRandomBytes32();this.logger.debug({method:r,methodId:t},"Method start");const n=this.validateParamSchema(e,c.ProtocolParams.DepositSchema);if(n)return c.Result.fail(n);const o={channelAddress:e.channelAddress,type:c.UpdateType.deposit,details:e},d=yield this.executeUpdate(o);return this.logger.debug({result:d.isError?c.jsonifyError(d.getError()):d.getValue(),method:r,methodId:t},"Method complete"),d}))}create(e){return l(this,void 0,void 0,(function*(){const r="create",t=f.getRandomBytes32();this.logger.debug({method:r,methodId:t},"Method start");const n=this.validateParamSchema(e,c.ProtocolParams.CreateSchema);if(n)return c.Result.fail(n);const o={channelAddress:e.channelAddress,type:c.UpdateType.create,details:e},d=yield this.executeUpdate(o);return this.logger.debug({result:d.isError?c.jsonifyError(d.getError()):d.getValue(),method:r,methodId:t},"Method complete"),d}))}resolve(e){return l(this,void 0,void 0,(function*(){const r="resolve",t=f.getRandomBytes32();this.logger.debug({method:r,methodId:t},"Method start");const n=this.validateParamSchema(e,c.ProtocolParams.ResolveSchema);if(n)return c.Result.fail(n);const o={channelAddress:e.channelAddress,type:c.UpdateType.resolve,details:e},d=yield this.executeUpdate(o);return this.logger.debug({result:d.isError?c.jsonifyError(d.getError()):d.getValue(),method:r,methodId:t},"Method complete"),d}))}getChannelState(e){return l(this,void 0,void 0,(function*(){return this.storeService.getChannelState(e)}))}getActiveTransfers(e){return l(this,void 0,void 0,(function*(){return this.storeService.getActiveTransfers(e)}))}getChannelStateByParticipants(e,r,t){return l(this,void 0,void 0,(function*(){return this.storeService.getChannelStateByParticipants(e,r,t)}))}getTransferState(e){return l(this,void 0,void 0,(function*(){return this.storeService.getTransferState(e)}))}getChannelStates(){return l(this,void 0,void 0,(function*(){return this.storeService.getChannelStates()}))}on(e,r,filter=(e=>!0)){this.evts[e].pipe(filter).attach(r)}once(e,r,filter=(e=>!0)){this.evts[e].pipe(filter).attachOnce(r)}waitFor(e,r,filter=(e=>!0)){return this.evts[e].pipe(filter).waitFor(r)}off(e){return l(this,void 0,void 0,(function*(){e?this.evts[e].detach():(Object.values(this.evts).forEach((e=>e.detach())),yield this.messagingService.disconnect())}))}}r.Vector=I},2900:function(e,r,t){"use strict";var n=this&&this.__awaiter||function(e,r,t,n){return new(t||(t=Promise))((function(o,d){function l(e){try{f(n.next(e))}catch(e){d(e)}}function c(e){try{f(n.throw(e))}catch(e){d(e)}}function f(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(l,c)}f((n=n.apply(e,r||[])).next())}))},o=this&&this.__rest||function(s,e){var r={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(r[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(r[p[i]]=s[p[i]])}return r};Object.defineProperty(r,"__esModule",{value:!0}),r.inbound=r.outbound=void 0;const d=t(27),l=t(50),c=t(472),f=t(473),h=t(2901);r.outbound=function(e,r,t,o,v,E,I){var y,A;return n(this,void 0,void 0,(function*(){const n="outbound",R=l.getRandomBytes32();I.debug({method:n,methodId:R},"Method start");const w=yield f.extractContextFromStore(r,e.channelAddress);if(w.isError)return d.Result.fail(new c.OutboundChannelUpdateError(c.OutboundChannelUpdateError.reasons.StoreFailure,e,void 0,{storeError:null===(y=w.getError())||void 0===y?void 0:y.message,method:n}));let{activeTransfers:S,channelState:C}=w.getValue();const T=yield h.validateParamsAndApplyUpdate(E,t,v,e,C,S,E.publicIdentifier,I);if(T.isError)return I.warn({method:n,methodId:R,error:d.jsonifyError(T.getError())},"Failed to apply proposed update"),d.Result.fail(T.getError());let{update:x,updatedChannel:U,updatedTransfer:N,updatedActiveTransfers:O}=T.getValue();I.debug({method:n,channel:U.channelAddress,transfer:null==N?void 0:N.transferId,type:e.type},"Generated update"),I.debug({method:n,methodId:R,to:x.toIdentifier,type:x.type},"Sending protocol message");let P=yield o.sendProtocolMessage(x,null==C?void 0:C.latestUpdate),F=P.getError();if(F&&F.message===c.InboundChannelUpdateError.reasons.StaleUpdate){I.warn({method:n,methodId:R,proposed:x.nonce,error:d.jsonifyError(F)},"Behind, syncing and retrying");const l=yield m(F,e,C,S,r,t,v,E,I);if(l.isError)return I.error({method:n,methodId:R,error:d.jsonifyError(l.getError())},"Error syncing channel"),d.Result.fail(l.getError());const c=l.getValue();P=yield o.sendProtocolMessage(c.update,c.updatedChannel.latestUpdate),F=P.getError(),C=c.syncedChannel,x=c.update,U=c.updatedChannel,N=c.updatedTransfer,O=c.updatedActiveTransfers}if(F)return I.error({method:n,methodId:R,error:d.jsonifyError(F)},"Error receiving response, will not save state!"),d.Result.fail(new c.OutboundChannelUpdateError(F.message===d.MessagingError.reasons.Timeout?c.OutboundChannelUpdateError.reasons.CounterpartyOffline:c.OutboundChannelUpdateError.reasons.CounterpartyFailure,e,C,{counterpartyError:d.jsonifyError(F)}));I.debug({method:n,methodId:R,to:x.toIdentifier,type:x.type},"Received protocol response");const{update:j}=P.getValue(),k=yield f.validateChannelSignatures(U,j.aliceSignature,j.bobSignature,"both",I);if(k.isError){const r=new c.OutboundChannelUpdateError(c.OutboundChannelUpdateError.reasons.BadSignatures,e,C,{recoveryError:null===(A=k.getError())||void 0===A?void 0:A.message});return I.error({method:n,error:d.jsonifyError(r)},"Error receiving response, will not save state!"),d.Result.fail(r)}try{return yield r.saveChannelState(Object.assign(Object.assign({},U),{latestUpdate:j}),N),I.debug({method:n,methodId:R},"Method complete"),d.Result.ok({updatedChannel:Object.assign(Object.assign({},U),{latestUpdate:j}),updatedTransfers:O,updatedTransfer:N})}catch(r){return d.Result.fail(new c.OutboundChannelUpdateError(c.OutboundChannelUpdateError.reasons.SaveChannelFailed,e,Object.assign(Object.assign({},U),{latestUpdate:j}),{saveChannelError:r.message}))}}))},r.inbound=function(e,r,t,m,E,I,y,A,R){var w,S,C;return n(this,void 0,void 0,(function*(){const T="inbound",x=l.getRandomBytes32();R.debug({method:T,methodId:x},"Method start");const U=(r,o=e,l,f={})=>n(this,void 0,void 0,(function*(){R.error({method:T,methodId:x,channel:e.channelAddress,error:r,context:f},"Error responding to channel update");const n=new c.InboundChannelUpdateError(r,o,l,f);return yield I.respondWithProtocolError(t,n),d.Result.fail(n)})),N=yield f.extractContextFromStore(E,e.channelAddress);if(N.isError)return U(c.InboundChannelUpdateError.reasons.StoreFailure,void 0,void 0,{storeError:null===(w=N.getError())||void 0===w?void 0:w.message});let{activeTransfers:O,channelState:P}=N.getValue();const F=null!==(S=null==P?void 0:P.nonce)&&void 0!==S?S:0,j=e.nonce-F;if(j<=0)return U(c.InboundChannelUpdateError.reasons.StaleUpdate,P.latestUpdate,P);if(j>=3)return U(c.InboundChannelUpdateError.reasons.RestoreNeeded,e,P,{counterpartyLatestUpdate:r,ourLatestNonce:F});let k=P?Object.assign({},P):void 0;if(2===j){if(!r)return U(c.InboundChannelUpdateError.reasons.StaleChannel,r,k);const e=yield v(r,k,O,(e=>d.Result.fail(new c.InboundChannelUpdateError(e!==c.InboundChannelUpdateError.reasons.CannotSyncSetup?c.InboundChannelUpdateError.reasons.SyncFailure:c.InboundChannelUpdateError.reasons.CannotSyncSetup,r,k,{syncError:e}))),E,m,y,A,R);if(e.isError){const r=e.getError();return U(r.message,r.context.update,r.context.state,r.context)}const{updatedChannel:t,updatedActiveTransfers:n}=e.getValue();k=t,O=n}const _=yield h.validateAndApplyInboundUpdate(m,y,A,e,k,O,R);if(_.isError){const r=null===(C=_.getError())||void 0===C?void 0:C.context,{state:t,params:n,update:d}=r,l=o(r,["state","params","update"]);return U(_.getError().message,e,k,l)}const{updatedChannel:D,updatedActiveTransfers:M,updatedTransfer:V}=_.getValue();try{yield E.saveChannelState(D,V)}catch(r){return U(c.InboundChannelUpdateError.reasons.SaveChannelFailed,e,k,{saveChannelError:r.message})}return yield I.respondToProtocolMessage(t,D.latestUpdate,k?k.latestUpdate:void 0),d.Result.ok({updatedActiveTransfers:M,updatedChannel:D,updatedTransfer:V})}))};const m=(e,r,t,l,f,m,E,I,y)=>n(void 0,void 0,void 0,(function*(){var n,A;const R=e.context.update;if(!R)return d.Result.fail(new c.OutboundChannelUpdateError(c.OutboundChannelUpdateError.reasons.NoUpdateToSync,r,t,{receivedError:d.jsonifyError(e)}));if(1!==R.nonce-(null!==(n=null==t?void 0:t.nonce)&&void 0!==n?n:0))return d.Result.fail(new c.OutboundChannelUpdateError(c.OutboundChannelUpdateError.reasons.RestoreNeeded,r,t,{counterpartyUpdate:R,latestNonce:t.nonce}));const w=yield v(R,t,l,(e=>d.Result.fail(new c.OutboundChannelUpdateError(e!==c.InboundChannelUpdateError.reasons.CannotSyncSetup?c.OutboundChannelUpdateError.reasons.SyncFailure:c.OutboundChannelUpdateError.reasons.CannotSyncSetup,r,t,{syncError:e}))),f,m,E,I,y);if(w.isError)return d.Result.fail(w.getError());const{updatedChannel:S,updatedActiveTransfers:C}=w.getValue(),T=yield h.validateParamsAndApplyUpdate(I,m,E,r,S,C,I.publicIdentifier,y);if(T.isError){const e=null===(A=T.getError())||void 0===A?void 0:A.context,{state:t,params:n,update:l}=e,f=o(e,["state","params","update"]);return d.Result.fail(new c.OutboundChannelUpdateError(c.OutboundChannelUpdateError.reasons.RegenerateUpdateFailed,r,S,{regenerateUpdateError:T.getError().message,regenerateUpdateContext:f}))}return d.Result.ok(Object.assign(Object.assign({},T.getValue()),{syncedChannel:S}))})),v=(e,r,t,o,l,f,m,v,E)=>n(void 0,void 0,void 0,(function*(){if(e.type===d.UpdateType.setup)return o(c.InboundChannelUpdateError.reasons.CannotSyncSetup);if(!e.aliceSignature||!e.bobSignature)return o("Cannot sync single signed state");const n=yield h.validateAndApplyInboundUpdate(f,m,v,e,r,t,E);if(n.isError)return o(n.getError().message);const{updatedChannel:I,updatedTransfer:y}=n.getValue();try{yield l.saveChannelState(I,y)}catch(e){return o(e.message)}return d.Result.ok(n.getValue())}))},2901:function(e,r,t){"use strict";var n=this&&this.__awaiter||function(e,r,t,n){return new(t||(t=Promise))((function(o,d){function l(e){try{f(n.next(e))}catch(e){d(e)}}function c(e){try{f(n.throw(e))}catch(e){d(e)}}function f(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(l,c)}f((n=n.apply(e,r||[])).next())}))},o=this&&this.__rest||function(s,e){var r={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(r[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(r[p[i]]=s[p[i]])}return r};Object.defineProperty(r,"__esModule",{value:!0}),r.validateAndApplyInboundUpdate=r.validateParamsAndApplyUpdate=r.validateUpdateParams=void 0;const d=t(27),l=t(50),c=t(32),f=t(654),h=t(472),m=t(2902),v=t(473);function E(e,r,t,o,m,v){var E,I,y,A,R,w;return n(this,void 0,void 0,(function*(){const n=(e,r={})=>d.Result.fail(new h.ValidationError(e,t,o,Object.assign(Object.assign({},r),{method:"validateUpdateParams"})));if(t.type!==d.UpdateType.setup&&!o)return n(h.ValidationError.reasons.ChannelNotFound);if(null!==(E=null==o?void 0:o.inDispute)&&void 0!==E&&E)return n(h.ValidationError.reasons.InDispute);const{type:S,channelAddress:C,details:details}=t;if(o&&C!==o.channelAddress)return n(h.ValidationError.reasons.InvalidChannelAddress);const T=(null!==(I=null==o?void 0:o.assetIds)&&void 0!==I?I:[]).length;if((null!==(y=null==o?void 0:o.defundNonces)&&void 0!==y?y:[]).length!==T||(null!==(A=null==o?void 0:o.balances)&&void 0!==A?A:[]).length!==T||(null!==(R=null==o?void 0:o.processedDepositsA)&&void 0!==R?R:[]).length!==T||(null!==(w=null==o?void 0:o.processedDepositsB)&&void 0!==w?w:[]).length!==T)return n(h.ValidationError.reasons.InvalidArrayLength);switch(S){case d.UpdateType.setup:{const{counterpartyIdentifier:e,timeout:t,networkContext:c}=details;if(o)return n(h.ValidationError.reasons.ChannelAlreadySetup);const m=yield r.getChannelAddress(l.getSignerAddressFromPublicIdentifier(v),l.getSignerAddressFromPublicIdentifier(e),c.channelFactoryAddress,c.chainId);if(m.isError)return n(h.ValidationError.reasons.ChainServiceFailure,{chainServiceMethod:"getChannelAddress",chainServiceError:d.jsonifyError(m.getError())});if(C!==m.getValue())return n(h.ValidationError.reasons.InvalidChannelAddress);const E=f.BigNumber.from(t);if(E.lt(d.MINIMUM_CHANNEL_TIMEOUT))return n(h.ValidationError.reasons.ShortChannelTimeout);if(E.gt(d.MAXIMUM_CHANNEL_TIMEOUT))return n(h.ValidationError.reasons.LongChannelTimeout);if(e===v)return n(h.ValidationError.reasons.InvalidCounterparty);break}case d.UpdateType.deposit:{const{assetId:e}=details;if(!c.isAddress(e))return n(h.ValidationError.reasons.InvalidAssetId);if(!o)return n(h.ValidationError.reasons.ChannelNotFound);if(o.assetIds.length>=100)return n(h.ValidationError.reasons.TooManyAssets);break}case d.UpdateType.create:{const{balance:t,assetId:E,transferDefinition:I,transferInitialState:y,timeout:A}=details;if(!o)return n(h.ValidationError.reasons.ChannelNotFound);const R=o.assetIds.findIndex((a=>c.getAddress(a)===c.getAddress(E)));if(R<0)return n(h.ValidationError.reasons.AssetNotFound);const w=l.getTransferId(o.channelAddress,o.nonce.toString(),I,A);if(m.find((e=>e.transferId===w)))return n(h.ValidationError.reasons.DuplicateTransferId);const S=e.address===o.alice,C=f.BigNumber.from(o.balances[R].amount[S?0:1]),T=f.BigNumber.from(o.balances[R].amount[S?1:0]),x=e.publicIdentifier===v;if(C.lt(t.amount[x?0:1])||T.lt(t.amount[x?1:0]))return n(h.ValidationError.reasons.InsufficientFunds);const U=f.BigNumber.from(A);if(U.gte(o.timeout))return n(h.ValidationError.reasons.TransferTimeoutAboveChannel);if(U.lt(d.MINIMUM_TRANSFER_TIMEOUT))return n(h.ValidationError.reasons.TransferTimeoutBelowMin);if(U.gt(d.MAXIMUM_TRANSFER_TIMEOUT))return n(h.ValidationError.reasons.TransferTimeoutAboveMax);const N=yield r.create(y,t,I,o.networkContext.transferRegistryAddress,o.networkContext.chainId);if(N.isError)return n(h.ValidationError.reasons.ChainServiceFailure,{chainServiceMethod:"create",chainServiceError:d.jsonifyError(N.getError())});if(!N.getValue())return n(h.ValidationError.reasons.InvalidInitialState);break}case d.UpdateType.resolve:{const{transferId:e,transferResolver:r}=details;if(!o)return n(h.ValidationError.reasons.ChannelNotFound);const t=m.find((r=>r.transferId===e));if(!t)return n(h.ValidationError.reasons.TransferNotActive);if("object"!=typeof r)return n(h.ValidationError.reasons.InvalidResolver);if(l.getSignerAddressFromPublicIdentifier(v)!==t.responder)return n(h.ValidationError.reasons.OnlyResponderCanInitiateResolve);if(t.transferResolver)return n(h.ValidationError.reasons.TransferResolved);break}default:return n(h.ValidationError.reasons.UnrecognizedType)}return d.Result.ok(void 0)}))}r.validateUpdateParams=E;r.validateParamsAndApplyUpdate=(e,r,t,l,c,f,v,I)=>n(void 0,void 0,void 0,(function*(){const n=yield E(e,r,l,c,f,v);if(n.isError){const e=n.getError(),r=e.context,{state:t,params:l}=r,f=o(r,["state","params"]);return d.Result.fail(new h.OutboundChannelUpdateError(h.OutboundChannelUpdateError.reasons.OutboundValidationFailed,l,c,{validationError:e.message,validationContext:f}))}if(v===e.publicIdentifier){const e=yield t.validateOutbound(l,c,f);if(e.isError)return d.Result.fail(new h.OutboundChannelUpdateError(h.OutboundChannelUpdateError.reasons.ExternalValidationFailed,l,c,{externalValidationError:e.getError().message}))}const y=yield m.generateAndApplyUpdate(e,r,l,c,f,v,I);if(y.isError){const e=y.getError(),r=e.context,{state:t,params:n}=r,f=o(r,["state","params"]);return d.Result.fail(new h.OutboundChannelUpdateError(h.OutboundChannelUpdateError.reasons.GenerateUpdateFailed,l,c,{generateError:e.message,generateContext:f}))}return d.Result.ok(y.getValue())})),r.validateAndApplyInboundUpdate=function(e,t,l,c,f,E,I){var y,A,R,w,S,C,T,x,U;return n(this,void 0,void 0,(function*(){const n=v.validateSchema(c,d.TChannelUpdate);if(n)return d.Result.fail(new h.InboundChannelUpdateError(h.InboundChannelUpdateError.reasons.MalformedUpdate,c,f,{updateError:n}));const N={[d.UpdateType.create]:d.TCreateUpdateDetails,[d.UpdateType.setup]:d.TSetupUpdateDetails,[d.UpdateType.deposit]:d.TDepositUpdateDetails,[d.UpdateType.resolve]:d.TResolveUpdateDetails},O=v.validateSchema(c.details,N[c.type]);if(O)return d.Result.fail(new h.InboundChannelUpdateError(h.InboundChannelUpdateError.reasons.MalformedDetails,c,f,{detailsError:O}));const P=(null!==(y=null==f?void 0:f.nonce)&&void 0!==y?y:0)+1;if(c.nonce!==P)return d.Result.fail(new h.InboundChannelUpdateError(h.InboundChannelUpdateError.reasons.InvalidUpdateNonce,c,f));if(c.aliceSignature&&c.bobSignature){let r;if(c.type===d.UpdateType.resolve){const t=E.find((e=>e.transferId===c.details.transferId));if(!t)return d.Result.fail(new h.InboundChannelUpdateError(h.InboundChannelUpdateError.reasons.TransferNotActive,c,f,{existing:E.map((e=>e.transferId))}));const n=yield e.resolve(Object.assign(Object.assign({},null!==(A=t)&&void 0!==A?A:{}),{transferResolver:c.details.transferResolver}),f.networkContext.chainId);if(n.isError)return d.Result.fail(new h.InboundChannelUpdateError(h.InboundChannelUpdateError.reasons.CouldNotGetFinalBalance,c,f,{chainServiceError:d.jsonifyError(n.getError())}));r=n.getValue()}const t=m.applyUpdate(c,f,E,r);if(t.isError){const e=null===(R=t.getError())||void 0===R?void 0:R.context,{state:r,params:n,update:l}=e,m=o(e,["state","params","update"]);return d.Result.fail(new h.InboundChannelUpdateError(h.InboundChannelUpdateError.reasons.ApplyUpdateFailed,c,f,{applyUpdateError:null===(w=t.getError())||void 0===w?void 0:w.message,applyUpdateContext:m}))}const{updatedChannel:n,updatedActiveTransfers:l,updatedTransfer:y}=t.getValue(),C=yield v.validateChannelSignatures(n,c.aliceSignature,c.bobSignature,"both",I);return C.isError?d.Result.fail(new h.InboundChannelUpdateError(h.InboundChannelUpdateError.reasons.BadSignatures,c,f,{validateSignatureError:null===(S=C.getError())||void 0===S?void 0:S.message})):d.Result.ok({updatedChannel:Object.assign(Object.assign({},n),{latestUpdate:Object.assign(Object.assign({},n.latestUpdate),{aliceSignature:c.aliceSignature,bobSignature:c.bobSignature})}),updatedActiveTransfers:l,updatedTransfer:y})}const F=yield t.validateInbound(c,f,E);if(F.isError)return d.Result.fail(new h.InboundChannelUpdateError(h.InboundChannelUpdateError.reasons.ExternalValidationFailed,c,f,{externalValidationError:null===(C=F.getError())||void 0===C?void 0:C.message}));const j=v.getParamsFromUpdate(c);if(j.isError)return d.Result.fail(new h.InboundChannelUpdateError(h.InboundChannelUpdateError.reasons.CouldNotGetParams,c,f,{getParamsError:null===(T=j.getError())||void 0===T?void 0:T.message}));const k=yield r.validateParamsAndApplyUpdate(l,e,t,j.getValue(),f,E,c.fromIdentifier,I);if(k.isError){const e=k.getError().context,{state:r,params:t}=e,n=o(e,["state","params"]);return d.Result.fail(new h.InboundChannelUpdateError(h.InboundChannelUpdateError.reasons.ApplyAndValidateInboundFailed,c,f,{validationError:k.getError().message,validationContext:n}))}const{updatedChannel:_,updatedActiveTransfers:D,updatedTransfer:M}=k.getValue(),V=yield v.validateChannelSignatures(_,c.aliceSignature,c.bobSignature,l.address===_.bob?"alice":"bob",I);if(V.isError)return d.Result.fail(new h.InboundChannelUpdateError(h.InboundChannelUpdateError.reasons.BadSignatures,c,f,{signatureError:null===(x=V.getError())||void 0===x?void 0:x.message}));const B=yield v.generateSignedChannelCommitment(_,l,c.aliceSignature,c.bobSignature,I);if(B.isError)return d.Result.fail(new h.InboundChannelUpdateError(h.InboundChannelUpdateError.reasons.GenerateSignatureFailed,c,f,{signatureError:null===(U=B.getError())||void 0===U?void 0:U.message}));const L=B.getValue(),W=Object.assign(Object.assign({},_),{latestUpdate:Object.assign(Object.assign({},_.latestUpdate),{aliceSignature:L.aliceSignature,bobSignature:L.bobSignature})});return d.Result.ok({updatedChannel:W,updatedActiveTransfers:D,updatedTransfer:M})}))}},2902:function(e,r,t){"use strict";var n=this&&this.__awaiter||function(e,r,t,n){return new(t||(t=Promise))((function(o,d){function l(e){try{f(n.next(e))}catch(e){d(e)}}function c(e){try{f(n.throw(e))}catch(e){d(e)}}function f(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(l,c)}f((n=n.apply(e,r||[])).next())}))},o=this&&this.__rest||function(s,e){var r={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(r[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(r[p[i]]=s[p[i]])}return r};Object.defineProperty(r,"__esModule",{value:!0}),r.generateAndApplyUpdate=r.applyUpdate=void 0;const d=t(50),l=t(27),c=t(32),f=t(3157),h=t(472),m=t(473);function v(e,r,t,n){var o,v;const{type:E,details:details,channelAddress:y,fromIdentifier:A,toIdentifier:R,balance:w,assetId:S,nonce:C}=e,T=(null!==(o=null==r?void 0:r.assetIds)&&void 0!==o?o:[]).findIndex((a=>c.getAddress(a)===c.getAddress(S)));if(!r&&E!==l.UpdateType.setup)return l.Result.fail(new h.ApplyUpdateError(h.ApplyUpdateError.reasons.ChannelNotFound,e,r));if(!n&&E===l.UpdateType.resolve)return l.Result.fail(new h.ApplyUpdateError(h.ApplyUpdateError.reasons.MissingFinalBalance,e,r));switch(E){case l.UpdateType.setup:{const{timeout:r,networkContext:n}=details;return l.Result.ok({updatedActiveTransfers:[...t],updatedChannel:{nonce:1,channelAddress:y,timeout:r,alice:d.getSignerAddressFromPublicIdentifier(A),bob:d.getSignerAddressFromPublicIdentifier(R),balances:[],processedDepositsA:[],processedDepositsB:[],assetIds:[],defundNonces:[],merkleRoot:f.HashZero,latestUpdate:e,networkContext:n,aliceIdentifier:A,bobIdentifier:R,inDispute:!1}})}case l.UpdateType.deposit:{const{totalDepositsAlice:n,totalDepositsBob:o}=details,d=I(w,S,r.balances,r.assetIds),{processedDepositsA:f,processedDepositsB:h}=function(e,r,t,n,o,d){const l=d.findIndex((a=>c.getAddress(a)===c.getAddress(o)));if(-1===l)return{processedDepositsA:[...e,t],processedDepositsB:[...r,n]};const f=[...e],h=[...r];return f[l]=t,h[l]=n,{processedDepositsA:f,processedDepositsB:h}}(r.processedDepositsA,r.processedDepositsB,n,o,S,r.assetIds),v=Object.assign(Object.assign({},r),{balances:d,processedDepositsA:f,processedDepositsB:h,assetIds:-1!==T?r.assetIds:[...r.assetIds,S],defundNonces:-1!==T?[...r.defundNonces]:[...r.defundNonces,"1"],nonce:C,latestUpdate:e});return l.Result.ok({updatedActiveTransfers:[...t],updatedChannel:m.mergeAssetIds(v)})}case l.UpdateType.create:{const{merkleRoot:n,transferInitialState:o,transferDefinition:c,transferTimeout:f,meta:meta,transferId:h,balance:m,transferEncodings:v}=details,E=I(w,S,r.balances,r.assetIds),A=Object.assign(Object.assign({},r),{balances:E,nonce:C,merkleRoot:n,latestUpdate:e}),R=d.getSignerAddressFromPublicIdentifier(e.fromIdentifier),T={balance:m,assetId:S,transferId:h,channelAddress:y,transferDefinition:c,transferEncodings:v,transferTimeout:f,initialStateHash:d.hashTransferState(o,v[0]),transferState:Object.assign({balance:m},o),channelFactoryAddress:r.networkContext.channelFactoryAddress,chainId:r.networkContext.chainId,transferResolver:void 0,initiator:R,responder:R===r.alice?r.bob:r.alice,meta:Object.assign(Object.assign({},null!=meta?meta:{}),{createdAt:Date.now()}),inDispute:!1,channelNonce:r.nonce,initiatorIdentifier:e.fromIdentifier,responderIdentifier:e.toIdentifier};return l.Result.ok({updatedChannel:A,updatedTransfer:T,updatedActiveTransfers:[...t,T]})}case l.UpdateType.resolve:{const{merkleRoot:o,transferId:d,transferResolver:c,meta:meta}=details,f=t.find((e=>e.transferId===d));if(!f)return l.Result.fail(new h.ApplyUpdateError(h.ApplyUpdateError.reasons.TransferNotActive,e,r));const m=I(w,S,r.balances,r.assetIds),E=Object.assign(Object.assign({},r),{balances:m,nonce:C,merkleRoot:o,latestUpdate:e}),y=Object.assign(Object.assign({},f),{transferResolver:Object.assign({},c),balance:n,meta:Object.assign(Object.assign(Object.assign({},null!==(v=f.meta)&&void 0!==v?v:{}),null!=meta?meta:{}),{resolvedAt:Date.now()})});return l.Result.ok({updatedChannel:E,updatedTransfer:y,updatedActiveTransfers:t.filter((e=>e.transferId!==d))})}default:return l.Result.fail(new h.ApplyUpdateError(h.ApplyUpdateError.reasons.BadUpdateType,e,r))}}function E(e,r,t,n){const o=t.publicIdentifier===n,d=t.publicIdentifier===e.bobIdentifier?e.aliceIdentifier:e.bobIdentifier;return{nonce:e.nonce+1,channelAddress:e.channelAddress,type:r.type,fromIdentifier:n,toIdentifier:o?d:t.publicIdentifier}}function I(e,r,t,n){const o=n.findIndex((a=>c.getAddress(a)===c.getAddress(r)));if(-1===o)return[...t,e];const d=[...t];return d[o]=e,d}r.applyUpdate=v,r.generateAndApplyUpdate=function(e,r,t,I,y,A,R){return n(this,void 0,void 0,(function*(){let w,S;switch(t.type){case l.UpdateType.setup:w=function(e,r){var t;const n=[r,e.details.counterpartyIdentifier].map(d.getSignerAddressFromPublicIdentifier);return{nonce:1,channelAddress:e.channelAddress,type:l.UpdateType.setup,fromIdentifier:r,toIdentifier:e.details.counterpartyIdentifier,balance:{to:n,amount:["0","0"]},details:{networkContext:e.details.networkContext,timeout:e.details.timeout,meta:null!==(t=e.details.meta)&&void 0!==t?t:{}},assetId:f.AddressZero}}(t,A);break;case l.UpdateType.deposit:{const o=yield function(e,r,t,o,d){var f;return n(this,void 0,void 0,(function*(){const{assetId:n}=r.details,v=e.assetIds.findIndex((a=>c.getAddress(a)===c.getAddress(n))),I=-1===v?{to:[e.alice,e.bob],amount:["0","0"]}:e.balances[v],y=-1===v?"0":e.processedDepositsA[v],A=-1===v?"0":e.processedDepositsB[v],R=yield m.reconcileDeposit(e.channelAddress,e.networkContext.chainId,I,y,A,n,o);if(R.isError)return l.Result.fail(new h.CreateUpdateError(h.CreateUpdateError.reasons.FailedToReconcileDeposit,r,e,{reconcileError:l.jsonifyError(R.getError())}));const{balance:w,totalDepositsAlice:S,totalDepositsBob:C}=R.getValue(),T=Object.assign(Object.assign({},E(e,r,t,d)),{balance:w,processedDepositsA:S,processedDepositsB:C,assetId:n,details:{totalDepositsAlice:S,totalDepositsBob:C,meta:null!==(f=r.details.meta)&&void 0!==f?f:{}}});return l.Result.ok(T)}))}(I,t,e,r,A);if(o.isError)return l.Result.fail(o.getError());w=o.getValue();break}case l.UpdateType.create:{const o=yield function(e,r,t,o,c,f){return n(this,void 0,void 0,(function*(){const{details:{assetId:n,transferDefinition:v,timeout:I,transferInitialState:y,meta:meta,balance:A}}=r,R=yield c.getRegisteredTransferByDefinition(v,e.networkContext.transferRegistryAddress,e.networkContext.chainId);if(R.isError)return l.Result.fail(new h.CreateUpdateError(h.CreateUpdateError.reasons.TransferNotRegistered,r,e,{registryError:l.jsonifyError(R.getError())}));const{stateEncoding:w,resolverEncoding:S}=R.getValue(),C=d.hashTransferState(y,w),T=t.address===e.alice?e.bobIdentifier:e.aliceIdentifier,x=t.address===e.alice?e.bob:e.alice,U={balance:A,assetId:n,transferId:d.getTransferId(e.channelAddress,e.nonce.toString(),v,I),channelAddress:e.channelAddress,transferDefinition:v,transferEncodings:[w,S],transferTimeout:I,initialStateHash:C,transferState:y,channelFactoryAddress:e.networkContext.channelFactoryAddress,chainId:e.networkContext.chainId,transferResolver:void 0,initiator:d.getSignerAddressFromPublicIdentifier(f),responder:t.publicIdentifier===f?x:t.address,meta:Object.assign(Object.assign({},null!=meta?meta:{}),{createdAt:Date.now()}),inDispute:!1,channelNonce:e.nonce,initiatorIdentifier:f,responderIdentifier:t.publicIdentifier===f?T:t.address},{proof:N,root:O}=d.generateMerkleTreeData([...o,U],U),P=m.getUpdatedChannelBalance(l.UpdateType.create,n,A,e,U.initiator),F=Object.assign(Object.assign({},E(e,r,t,f)),{balance:P,assetId:n,details:{transferId:U.transferId,transferDefinition:v,transferTimeout:I,balance:A,transferInitialState:y,transferEncodings:[w,S],merkleProofData:N,merkleRoot:O,meta:Object.assign(Object.assign({},null!=meta?meta:{}),{createdAt:Date.now()})}});return l.Result.ok(F)}))}(I,t,e,y,r,A);if(o.isError)return l.Result.fail(o.getError());w=o.getValue();break}case l.UpdateType.resolve:{const o=yield function(e,r,t,o,c,f){var v;return n(this,void 0,void 0,(function*(){const{transferId:n,transferResolver:I,meta:meta}=r.details,y=o.find((e=>e.transferId===n));if(!y)return l.Result.fail(new h.CreateUpdateError(h.CreateUpdateError.reasons.TransferNotActive,r,e,{active:o.map((e=>e.transferId))}));const{root:A}=d.generateMerkleTreeData(o.filter((e=>e.transferId!==n))),R=yield c.resolve(Object.assign(Object.assign({},y),{transferResolver:I}),e.networkContext.chainId);if(R.isError)return l.Result.fail(new h.CreateUpdateError(h.CreateUpdateError.reasons.FailedToResolveTransferOnchain,r,e,{resolveError:l.jsonifyError(R.getError())}));const w=R.getValue(),S=m.getUpdatedChannelBalance(l.UpdateType.resolve,y.assetId,w,e,y.initiator),C=Object.assign(Object.assign({},E(e,r,t,f)),{balance:S,assetId:y.assetId,details:{transferId:n,transferDefinition:y.transferDefinition,transferResolver:I,merkleRoot:A,meta:Object.assign(Object.assign({},null!==(v=y.meta)&&void 0!==v?v:{}),null!=meta?meta:{})}});return l.Result.ok({update:C,transferBalance:w})}))}(I,t,e,y,r,A);if(o.isError)return l.Result.fail(o.getError());const c=o.getValue();w=c.update,S=c.transferBalance;break}default:return l.Result.fail(new h.CreateUpdateError(h.CreateUpdateError.reasons.BadUpdateType,t,I))}const C=v(w,I,y,S);if(C.isError){const e=C.getError(),r=e.context,{state:t,params:n}=r,d=o(r,["state","params"]);return l.Result.fail(new h.CreateUpdateError(h.CreateUpdateError.reasons.CouldNotApplyUpdate,n,t,{applyUpdateError:e.message,applyUpdateContext:d}))}const{updatedChannel:T,updatedTransfer:x,updatedActiveTransfers:U}=C.getValue(),N=yield m.generateSignedChannelCommitment(T,e,void 0,void 0,R);if(N.isError)return l.Result.fail(new h.CreateUpdateError(h.CreateUpdateError.reasons.CouldNotSign,t,I,{signatureError:N.getError().message}));const{aliceSignature:O,bobSignature:P}=N.getValue();return l.Result.ok({update:Object.assign(Object.assign({},w),{aliceSignature:O,bobSignature:P}),updatedChannel:T,updatedActiveTransfers:U,updatedTransfer:x})}))}},2903:function(e){e.exports=JSON.parse('{"name":"@connext/vector-engine","version":"0.2.1-beta.12","description":"","author":"Arjun Bhuptani","license":"MIT","main":"dist/src/index.js","types":"dist/src/index.d.ts","directories":{"test":"tests"},"scripts":{"build":"rm -rf dist && tsc","test":"nyc ts-mocha --check-leaks --exit --timeout 60000 \'src/**/*.spec.ts\'"},"dependencies":{"@connext/vector-contracts":"0.2.1-beta.12","@connext/vector-protocol":"0.2.1-beta.12","@connext/vector-types":"0.2.1-beta.12","@connext/vector-utils":"0.2.1-beta.12","@ethersproject/address":"5.0.10","@ethersproject/bignumber":"5.0.14","@ethersproject/bytes":"5.0.10","@ethersproject/constants":"5.0.9","@ethersproject/random":"5.0.8","@ethersproject/wallet":"5.0.11","@sinclair/typebox":"0.12.7","ajv":"6.12.6","evt":"1.9.12","pino":"6.11.1","pino-pretty":"4.6.0"},"devDependencies":{"@types/chai":"4.2.15","@types/chai-as-promised":"7.1.3","@types/chai-subset":"1.3.3","@types/mocha":"8.2.1","@types/pino":"6.3.6","chai":"4.3.1","chai-as-promised":"7.1.1","mocha":"8.3.0","nyc":"15.1.0","sinon":"9.2.4","ts-mocha":"8.0.0","typescript":"4.2.2"}}')},2904:function(e,r,t){"use strict";var n=this&&this.__awaiter||function(e,r,t,n){return new(t||(t=Promise))((function(o,d){function l(e){try{f(n.next(e))}catch(e){d(e)}}function c(e){try{f(n.throw(e))}catch(e){d(e)}}function f(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(l,c)}f((n=n.apply(e,r||[])).next())}))};Object.defineProperty(r,"__esModule",{value:!0}),r.convertWithdrawParams=r.convertResolveConditionParams=r.convertConditionalTransferParams=r.convertSetupParams=void 0;const o=t(390),d=t(50),l=t(27),c=t(487),f=t(1068),h=t(1072),m=t(641);r.convertSetupParams=function(e,r){var t;return n(this,void 0,void 0,(function*(){return l.Result.ok({counterpartyIdentifier:e.counterpartyIdentifier,timeout:null!==(t=e.timeout)&&void 0!==t?t:l.DEFAULT_CHANNEL_TIMEOUT.toString(),networkContext:{channelFactoryAddress:r[e.chainId].channelFactoryAddress,transferRegistryAddress:r[e.chainId].transferRegistryAddress,chainId:e.chainId},meta:e.meta})}))},r.convertConditionalTransferParams=function(e,r,t,o,f){var v,E,I,y;return n(this,void 0,void 0,(function*(){const{channelAddress:n,amount:A,assetId:R,recipient:w,details:details,type:S,timeout:C,meta:T}=e,x=null!==(v=e.recipientChainId)&&void 0!==v?v:t.networkContext.chainId,U=h.getAddress(null!==(E=e.recipientAssetId)&&void 0!==E?E:e.assetId),N=r.address===t.alice?t.bob:t.alice;if(w===r.publicIdentifier&&x===t.networkContext.chainId)return l.Result.fail(new m.ParameterConversionError(m.ParameterConversionError.reasons.CannotSendToSelf,n,r.publicIdentifier,{params:e}));let O;if(w&&d.getSignerAddressFromPublicIdentifier(w)!==N){let o=e.quote;if(!o){const d=r.publicIdentifier!==t.aliceIdentifier?yield f.sendTransferQuoteMessage(l.Result.ok({amount:e.amount,assetId:e.assetId,chainId:t.networkContext.chainId,recipient:w,recipientChainId:x,recipientAssetId:U}),t.aliceIdentifier,r.publicIdentifier):l.Result.ok({signature:void 0,chainId:t.networkContext.chainId,routerIdentifier:r.publicIdentifier,amount:e.amount,assetId:e.assetId,recipient:w,recipientChainId:x,recipientAssetId:U,fee:"0",expiry:(Date.now()+l.DEFAULT_FEE_EXPIRY).toString()});if(d.isError)return l.Result.fail(new m.ParameterConversionError(m.ParameterConversionError.reasons.CouldNotGetQuote,n,r.publicIdentifier,{params:e,quoteError:l.jsonifyError(d.getError())}));o=d.getValue()}if(c.BigNumber.from(o.fee).gt(e.amount))return l.Result.fail(new m.ParameterConversionError(m.ParameterConversionError.reasons.FeeGreaterThanAmount,n,r.publicIdentifier,{quote:o}));O={requireOnline:null===(I=null==T?void 0:T.requireOnline)||void 0===I||I,routingId:null!==(y=null==T?void 0:T.routingId)&&void 0!==y?y:d.getRandomBytes32(),path:[{recipient:w,recipientChainId:x,recipientAssetId:U}],quote:Object.assign(Object.assign({},o),{routerIdentifier:t.aliceIdentifier,amount:e.amount,assetId:e.assetId,chainId:t.networkContext.chainId,recipient:w,recipientChainId:x,recipientAssetId:U})}}const P=S.startsWith("0x")?yield o.getRegisteredTransferByDefinition(S,t.networkContext.transferRegistryAddress,t.networkContext.chainId):yield o.getRegisteredTransferByName(S,t.networkContext.transferRegistryAddress,t.networkContext.chainId);if(P.isError)return l.Result.fail(new m.ParameterConversionError(m.ParameterConversionError.reasons.FailedToGetRegisteredTransfer,n,r.publicIdentifier,{params:e,registryError:l.jsonifyError(P.getError())}));const{definition:F}=P.getValue(),j=Object.assign({},details);return l.Result.ok({channelAddress:n,balance:{to:[r.address,N],amount:[A.toString(),"0"]},assetId:R,transferDefinition:F,transferInitialState:j,timeout:null!=C?C:l.DEFAULT_TRANSFER_TIMEOUT.toString(),meta:Object.assign(Object.assign({},null!=O?O:{}),null!=T?T:{})})}))},r.convertResolveConditionParams=function(e,r){var t;const{channelAddress:n,transferResolver:o,meta:meta}=e;return l.Result.ok({channelAddress:n,transferId:r.transferId,transferResolver:o,meta:Object.assign(Object.assign({},null!==(t=r.meta)&&void 0!==t?t:{}),null!=meta?meta:{})})},r.convertWithdrawParams=function(e,r,t,d,v,E){var I;return n(this,void 0,void 0,(function*(){const{channelAddress:n,callTo:y,callData:A,meta:meta,timeout:R}=e,w=h.getAddress(e.assetId),S=h.getAddress(e.recipient),C=null!==(I=e.initiatorSubmits)&&void 0!==I&&I;if(C&&r.address===t.alice)return l.Result.fail(new m.ParameterConversionError(m.ParameterConversionError.reasons.BobDoesntSubmitAlice,n,r.publicIdentifier,{params:e}));if(S===f.AddressZero)return l.Result.fail(new m.ParameterConversionError(m.ParameterConversionError.reasons.WithdrawToZero,n,r.publicIdentifier,{params:e}));const T=!y||y===f.AddressZero;if("0"===e.amount&&T)return l.Result.fail(new m.ParameterConversionError(m.ParameterConversionError.reasons.NoOp,n,r.publicIdentifier,{params:e}));let x=e.quote;if(!x){const o=r.publicIdentifier===t.aliceIdentifier||C?l.Result.ok({channelAddress:t.channelAddress,amount:e.amount,assetId:e.assetId,fee:"0",expiry:(Date.now()+l.DEFAULT_FEE_EXPIRY).toString()}):yield E.sendWithdrawalQuoteMessage(l.Result.ok({channelAddress:t.channelAddress,amount:e.amount,assetId:e.assetId}),t.aliceIdentifier,r.publicIdentifier);if(o.isError)return l.Result.fail(new m.ParameterConversionError(m.ParameterConversionError.reasons.CouldNotGetQuote,n,r.publicIdentifier,{params:e,quoteError:l.jsonifyError(o.getError())}));x=o.getValue()}const U=c.BigNumber.from(x.fee);if(U.gt(e.amount))return l.Result.fail(new m.ParameterConversionError(m.ParameterConversionError.reasons.FeeGreaterThanAmount,n,r.publicIdentifier,{params:e,quote:x}));const N=c.BigNumber.from(e.amount).sub(U).toString(),O=new o.WithdrawCommitment(t.channelAddress,t.alice,t.bob,e.recipient,w,N.toString(),t.nonce.toString(),y,A);let P;try{P=yield r.signMessage(O.hashToSign())}catch(t){return l.Result.fail(new m.ParameterConversionError(m.ParameterConversionError.reasons.CouldNotSignWithdrawal,n,r.publicIdentifier,{signatureError:t.message,params:e,commitment:O.toJson()}))}const F=t.alice===r.address?t.bob:t.alice,j={initiatorSignature:P,initiator:r.address,responder:F,data:O.hashToSign(),nonce:t.nonce.toString(),fee:U.toString(),callTo:null!=y?y:f.AddressZero,callData:null!=A?A:"0x"},k=yield v.getRegisteredTransferByName(l.TransferNames.Withdraw,d[t.networkContext.chainId].transferRegistryAddress,t.networkContext.chainId);if(k.isError)return l.Result.fail(new m.ParameterConversionError(m.ParameterConversionError.reasons.FailedToGetRegisteredTransfer,n,r.publicIdentifier,{params:e,registryError:l.jsonifyError(k.getError())}));const{definition:_}=k.getValue();return l.Result.ok({channelAddress:n,balance:{amount:[e.amount,"0"],to:[S,F]},assetId:w,transferDefinition:_,transferInitialState:j,timeout:null!=R?R:l.DEFAULT_TRANSFER_TIMEOUT.toString(),meta:Object.assign(Object.assign({},null!=meta?meta:{}),{quote:Object.assign(Object.assign({},x),{channelAddress:n,amount:N,assetId:e.assetId}),withdrawNonce:t.nonce.toString(),initiatorSubmits:C})})}))}},2905:function(e,r,t){"use strict";var n=this&&this.__awaiter||function(e,r,t,n){return new(t||(t=Promise))((function(o,d){function l(e){try{f(n.next(e))}catch(e){d(e)}}function c(e){try{f(n.throw(e))}catch(e){d(e)}}function f(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(l,c)}f((n=n.apply(e,r||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.resolveWithdrawal=r.resolveExistingWithdrawals=r.getWithdrawalQuote=r.setupEngineListeners=void 0;const d=t(390),l=t(27),c=t(50),f=t(1072),h=t(487),m=t(1068),v=o(t(455)),E=t(641),I=t(1005);function y(e,r,t,o,d,f){var v;return n(this,void 0,void 0,(function*(){const y=null!==(v=e.receiveExactAmount)&&void 0!==v&&v,A=r=>n(this,void 0,void 0,(function*(){const n=y?h.BigNumber.from(e.amount).add(r):e.amount,o={channelAddress:e.channelAddress,amount:r.gt(n)?"0":h.BigNumber.from(n).sub(r).toString(),assetId:e.assetId,fee:r.toString(),expiry:(Date.now()+l.DEFAULT_FEE_EXPIRY).toString()};try{const e=yield t.signMessage(c.hashWithdrawalQuote(o));return l.Result.ok(Object.assign(Object.assign({},o),{signature:e}))}catch(r){return l.Result.fail(new E.WithdrawQuoteError(E.WithdrawQuoteError.reasons.SignatureFailure,t.publicIdentifier,e,{error:l.jsonifyError(r)}))}}));if(100===r)return A(m.Zero);const R=yield o.getChannelState(e.channelAddress);if(!R)return l.Result.fail(new E.WithdrawQuoteError(E.WithdrawQuoteError.reasons.ChannelNotFound,t.publicIdentifier,e));const code=yield d.getCode(e.channelAddress,R.networkContext.chainId);if(code.isError)return l.Result.fail(new E.WithdrawQuoteError(E.WithdrawQuoteError.reasons.ChainServiceFailure,t.publicIdentifier,e,{chainServiceMethod:"getCode",error:l.jsonifyError(code.getError())}));const w="0x"!==code.getValue()?l.SIMPLE_WITHDRAWAL_GAS_ESTIMATE:l.SIMPLE_WITHDRAWAL_GAS_ESTIMATE.add(l.GAS_ESTIMATES.createChannel),S=yield d.getGasPrice(R.networkContext.chainId);if(S.isError)return l.Result.fail(new E.WithdrawQuoteError(E.WithdrawQuoteError.reasons.ChainServiceFailure,t.publicIdentifier,e,{chainServiceMethod:"getGasPrice",error:l.jsonifyError(S.getError())}));const C=yield d.getDecimals(e.assetId,R.networkContext.chainId);if(C.isError)return l.Result.fail(new E.WithdrawQuoteError(E.WithdrawQuoteError.reasons.ChainServiceFailure,t.publicIdentifier,e,{chainServiceMethod:"getDecimals",error:l.jsonifyError(C.getError())}));const T=1===R.networkContext.chainId||c.TESTNETS_WITH_FEES.includes(R.networkContext.chainId)?yield I.normalizeGasFees(w,18,e.assetId,C.getValue(),R.networkContext.chainId,d,f):l.Result.ok(m.Zero);if(T.isError)return l.Result.fail(new E.WithdrawQuoteError(E.WithdrawQuoteError.reasons.ExchangeRateError,t.publicIdentifier,e,{error:l.jsonifyError(T.getError())}));return A(T.getValue().mul(100-r).div(100))}))}function A(e,t,o,d,l,f,h,m,v){return n(this,void 0,void 0,(function*(){const E="resolveExistingWithdrawals",I=c.getRandomBytes32(),y=yield d.getActiveTransfers(e.channelAddress);m.info({method:E,methodId:I},"Got active transfers in isAlive channel");const A=(yield Promise.all(y.map((e=>n(this,void 0,void 0,(function*(){const r=yield R(e,l,f);return!r.isError&&r.getValue()?e:void 0})))))).filter((e=>!!e)).filter((e=>n(this,void 0,void 0,(function*(){return e.responderIdentifier===t.publicIdentifier}))));yield Promise.all(A.map((l=>n(this,void 0,void 0,(function*(){m.info({method:E,methodId:I,transfer:l.transferId},"Found withdrawal to handle"),yield r.resolveWithdrawal(e,l,d,h,o,t,f,m,v),m.info({method:E,methodId:I,transfer:l.transferId},"Resolved withdrawal")})))))}))}r.setupEngineListeners=function(e,t,o,m,I,w,S,C,T,x,U,N){return n(this,void 0,void 0,(function*(){o.on(l.ProtocolEventName.CHANNEL_UPDATE_EVENT,(r=>function(e,r,t,n,o){o.info({channelAddress:e.updatedChannelState.channelAddress},"Handling setup event");const{channelAddress:d,aliceIdentifier:c,bobIdentifier:f,networkContext:{chainId:h},latestUpdate:{details:{meta:meta}}}=e.updatedChannelState,m={channelAddress:d,aliceIdentifier:c,bobIdentifier:f,chainId:h,meta:meta};n[l.EngineEvents.SETUP].post(m)}(r,0,0,e,C)),(e=>{const{updatedChannelState:{latestUpdate:{type:r}}}=e;return r===l.UpdateType.setup})),o.on(l.ProtocolEventName.CHANNEL_UPDATE_EVENT,(r=>function(e,r,t,n,o){o.info({channelAddress:e.updatedChannelState.channelAddress},"Handling deposit reconciliation event");const{aliceIdentifier:d,bobIdentifier:c,channelAddress:h,balances:m,assetIds:v,latestUpdate:{assetId:E,details:{meta:meta}}}=e.updatedChannelState,I={aliceIdentifier:d,bobIdentifier:c,channelAddress:h,assetId:E,channelBalance:m[v.findIndex((a=>f.getAddress(a)===f.getAddress(E)))],meta:meta};n[l.EngineEvents.DEPOSIT_RECONCILED].post(I)}(r,0,0,e,C)),(e=>{const{updatedChannelState:{latestUpdate:{type:r}}}=e;return r===l.UpdateType.deposit})),o.on(l.ProtocolEventName.CHANNEL_UPDATE_EVENT,(r=>n(this,void 0,void 0,(function*(){return yield function(e,r,t,o,d,c){var h,m;return n(this,void 0,void 0,(function*(){const r=yield R(e.updatedTransfer,o,t);if(r.isError)return void c.warn(Object.assign({method:"isWithdrawRes"},r.getError().context),"Failed to determine if transfer is withdrawal");if(r.getValue())return;const{aliceIdentifier:n,bobIdentifier:v,assetIds:E,balances:I,channelAddress:y,networkContext:{chainId:A},latestUpdate:{assetId:w,details:{transferId:S,transferDefinition:C,meta:{routingId:T}}}}=e.updatedChannelState;c.info({channelAddress:y},"Handling conditional transfer create event");const x=e.updatedTransfer;if(!x)return void c.warn({transferId:S},"Transfer not found after creation");const U=yield t.getRegisteredTransferByDefinition(C,o[A].transferRegistryAddress,A);let N;U.isError?(c.warn({error:U.getError().message},"Failed to get registry info"),N=C):N=U.getValue().name;const O={aliceIdentifier:n,bobIdentifier:v,channelAddress:y,channelBalance:I[E.findIndex((a=>f.getAddress(a)===f.getAddress(w)))],transfer:x,conditionType:N,activeTransferIds:null===(h=e.updatedTransfers)||void 0===h?void 0:h.map((e=>e.transferId))};d[l.EngineEvents.CONDITIONAL_TRANSFER_CREATED].post(O),T&&(null===(m=x.meta)||void 0===m?void 0:m.routingId)===T||c.warn({transferId:S,routingId:T,meta:x.meta},"Cannot route transfer")}))}(r,0,t,S,e,C)}))),(e=>{const{updatedChannelState:{latestUpdate:{type:r}}}=e;return r===l.UpdateType.create})),o.on(l.ProtocolEventName.CHANNEL_UPDATE_EVENT,(r=>n(this,void 0,void 0,(function*(){return yield function(e,r,t,o,d,c){var h;return n(this,void 0,void 0,(function*(){const t=yield R(e.updatedTransfer,r,o);if(t.isError)return void c.warn(Object.assign({method:"isWithdrawRes"},t.getError().context),"Failed to determine if transfer is withdrawal");if(t.getValue())return;c.info({channelAddress:e.updatedChannelState.channelAddress},"Handling conditional transfer resolve event");const{aliceIdentifier:n,bobIdentifier:m,channelAddress:v,assetIds:E,balances:I,networkContext:{chainId:y},latestUpdate:{assetId:A,details:{transferDefinition:w}}}=e.updatedChannelState,S=yield o.getRegisteredTransferByDefinition(w,r[y].transferRegistryAddress,y);let C;S.isError?(c.warn({error:S.getError().message},"Faild to get registry info"),C=w):C=S.getValue().name;const T=e.updatedTransfer,x={aliceIdentifier:n,bobIdentifier:m,channelAddress:v,channelBalance:I[E.findIndex((a=>f.getAddress(a)===f.getAddress(A)))],transfer:T,conditionType:C,activeTransferIds:null===(h=e.updatedTransfers)||void 0===h?void 0:h.map((e=>e.transferId))};d[l.EngineEvents.CONDITIONAL_TRANSFER_RESOLVED].post(x)}))}(r,S,0,t,e,C)}))),(e=>{const{updatedChannelState:{latestUpdate:{type:r}}}=e;return r===l.UpdateType.resolve})),o.on(l.ProtocolEventName.CHANNEL_UPDATE_EVENT,(d=>n(this,void 0,void 0,(function*(){return yield function(e,t,o,d,c,f,h,m,v){return n(this,void 0,void 0,(function*(){const n=yield R(e.updatedTransfer,f,h);n.isError?m.warn({method:"handleWithdrawalTransferCreation",error:l.jsonifyError(n.getError())},"Failed to determine if transfer is withdrawal"):n.getValue()&&(yield r.resolveWithdrawal(e.updatedChannelState,e.updatedTransfer,o,c,d,t,h,m,v))}))}(d,I,o,w,e,S,t,C,N)}))),(e=>{const{updatedChannelState:{latestUpdate:{type:r}}}=e;return r===l.UpdateType.create})),o.on(l.ProtocolEventName.CHANNEL_UPDATE_EVENT,(r=>n(this,void 0,void 0,(function*(){return yield function(e,r,t,o,m,E,I=v.default()){var y;return n(this,void 0,void 0,(function*(){const n=yield R(e.updatedTransfer,m,E);if(n.isError)return void I.warn(Object.assign({method:"isWithdrawRes"},n.getError().context),"Failed to determine if transfer is withdrawal");if(!n.getValue())return;const v="handleWithdrawalTransferResolution",A=c.getRandomBytes32(),{aliceIdentifier:w,bobIdentifier:S,channelAddress:C,balances:T,assetIds:x,alice:U,bob:N,latestUpdate:{details:{transferId:O,meta:meta},assetId:P,fromIdentifier:F}}=e.updatedChannelState;if(I.info({method:v,channelAddress:C,transferId:O,methodId:A},"Started"),!e.updatedTransfer)return void I.warn({method:v,transferId:O,channelAddress:C},"Could not find transfer for withdrawal resolution");const j=e.updatedTransfer.transferState.balance.amount.reduce(((e,r)=>e.add(r)),h.BigNumber.from(0)).sub(e.updatedTransfer.transferState.fee);I.info({method:v,methodId:A,withdrawalAmount:j.toString(),initiator:e.updatedTransfer.initiator,responder:e.updatedTransfer.responder,fee:e.updatedTransfer.transferState.fee},"Withdrawal info");const k=new d.WithdrawCommitment(C,U,N,e.updatedTransfer.balance.to[0],P,j.toString(),e.updatedTransfer.transferState.nonce,e.updatedTransfer.transferState.callTo,e.updatedTransfer.transferState.callData,null!==(y=null==meta?void 0:meta.transactionHash)&&void 0!==y?y:void 0);yield k.addSignatures(e.updatedTransfer.transferState.initiatorSignature,e.updatedTransfer.transferResolver.responderSignature);const _=x.findIndex((a=>f.getAddress(a)===f.getAddress(P))),D={aliceIdentifier:w,bobIdentifier:S,assetId:P,amount:j.toString(),fee:e.updatedTransfer.transferState.fee,recipient:e.updatedTransfer.balance.to[0],channelBalance:T[_],channelAddress:C,transfer:e.updatedTransfer,callTo:e.updatedTransfer.transferState.callTo,callData:e.updatedTransfer.transferState.callData,transaction:k.getSignedTransaction()};if(o[l.EngineEvents.WITHDRAWAL_RESOLVED].post(D),F===r.publicIdentifier)return void I.debug({method:v,methodId:A,withdrawalAmount:j.toString(),assetId:P},"Our own resolution, no need to do anything");if(r.address!==U)return yield t.saveWithdrawalCommitment(O,k.toJson()),o[l.WITHDRAWAL_RECONCILED_EVENT].post({aliceIdentifier:w,bobIdentifier:S,channelAddress:C,transferId:O,transactionHash:null==meta?void 0:meta.transactionHash,meta:e.updatedTransfer.meta}),void I.info({method:v,methodId:A,withdrawalAmount:j.toString(),assetId:P},"Completed");if(1===e.updatedChannelState.networkContext.chainId)return yield t.saveWithdrawalCommitment(O,k.toJson()),void I.debug({method:v,channel:e.updatedChannelState.channelAddress},"Holding mainnet withdrawal");const M=yield E.sendWithdrawTx(e.updatedChannelState,k.getSignedTransaction());if(M.isError)return yield t.saveWithdrawalCommitment(O,k.toJson()),void I.warn({method:v,error:M.getError().message,channelAddress:C,transferId:O},"Failed to submit withdraw");const V=M.getValue();k.addTransaction(V.hash),yield t.saveWithdrawalCommitment(O,k.toJson()),o[l.WITHDRAWAL_RECONCILED_EVENT].post({aliceIdentifier:w,bobIdentifier:S,channelAddress:C,transferId:O,transactionHash:V.hash}),I.info({transactionHash:V.hash},"Submitted withdraw tx");const B=yield V.completed();B.isError?I.error({method:v,receipt:B.getError()},"Withdraw tx reverted"):I.info({method:v,transactionHash:B.getValue().transactionHash},"Withdraw tx mined, completed")}))}(r,I,w,e,S,t,C)}))),(e=>{const{updatedChannelState:{latestUpdate:{type:r}}}=e;return r===l.UpdateType.resolve})),yield m.onReceiveRestoreStateMessage(I.publicIdentifier,((r,t,o)=>n(this,void 0,void 0,(function*(){if(t===I.publicIdentifier)return;const d="onReceiveRestoreStateMessage";C.debug({method:d},"Handling message");const c=(r,t=!1)=>n(this,void 0,void 0,(function*(){const n=yield w.getChannelState(r);n?(yield U(n),yield m.respondToRestoreStateMessage(o,l.Result.ok(void 0)),t&&e[l.EngineEvents.RESTORE_STATE_EVENT].post({channelAddress:n.channelAddress,aliceIdentifier:n.aliceIdentifier,bobIdentifier:n.bobIdentifier,chainId:n.networkContext.chainId})):C.error({channelAddress:r},"Failed to find channel to release lock")}));if(r.isError)return C.error({message:r.getError().message,method:d},"Error received from counterparty restore"),void(yield c(r.getError().context.channelAddress));const data=r.getValue(),[f]=Object.keys(null!=data?data:[]);if("chainId"!==f&&"channelAddress"!==f)return void C.error({data:data},"Message malformed");if("channelAddress"===f){const{channelAddress:e}=data;return void(yield c(e,!0))}let h;const v=(e,r={})=>{var t;return m.respondToRestoreStateMessage(o,l.Result.fail(new E.RestoreError(e,null!==(t=null==h?void 0:h.channelAddress)&&void 0!==t?t:"",I.publicIdentifier,Object.assign(Object.assign({},r),{method:d}))))},{chainId:y}=data;try{h=yield w.getChannelStateByParticipants(I.publicIdentifier,t,y)}catch(e){return v(E.RestoreError.reasons.CouldNotGetChannel,{storeMethod:"getChannelStateByParticipants",chainId:y,identifiers:[I.publicIdentifier,t]})}if(!h)return v(E.RestoreError.reasons.ChannelNotFound,{chainId:y});let A;try{A=yield w.getActiveTransfers(h.channelAddress)}catch(e){return v(E.RestoreError.reasons.CouldNotGetActiveTransfers,{storeMethod:"getActiveTransfers",chainId:y,channelAddress:h.channelAddress})}const R=yield x(h);if(R.isError)return v(E.RestoreError.reasons.AcquireLockError,{acquireLockError:l.jsonifyError(R.getError())});C.debug({channel:h.channelAddress,nonce:h.nonce,activeTransfers:A.map((a=>a.transferId))},"Sending counterparty state to sync"),yield m.respondToRestoreStateMessage(o,l.Result.ok({channel:h,activeTransfers:A})),setTimeout((()=>{U(h)}),15e3)})))),yield m.onReceiveIsAliveMessage(I.publicIdentifier,((r,d,f)=>n(this,void 0,void 0,(function*(){var n,h;const v=d!==I.publicIdentifier,y="onReceiveIsAliveMessage",R=c.getRandomBytes32();if(r.isError)return void C.warn({error:null===(n=r.getError())||void 0===n?void 0:n.message,method:y,methodId:R},"Error received");const{channelAddress:T}=r.getValue(),x=yield w.getChannelState(T);if(!x)return C.error({channelAddress:T,method:y,methodId:R},"Channel not found"),void(v&&m.respondToIsAliveMessage(f,l.Result.fail(new E.IsAliveError(E.IsAliveError.reasons.ChannelNotFound,T,I.publicIdentifier))));e[l.IS_ALIVE_EVENT].post({aliceIdentifier:x.aliceIdentifier,bobIdentifier:x.bobIdentifier,chainId:x.networkContext.chainId,channelAddress:x.channelAddress,skipCheckIn:null!==(h=r.getValue().skipCheckIn)&&void 0!==h&&h}),A(x,I,w,o,S,t,e,C,N),v&&(yield m.respondToIsAliveMessage(f,l.Result.ok({channelAddress:T})))})))),yield m.onReceiveRequestCollateralMessage(I.publicIdentifier,((r,t,o)=>n(this,void 0,void 0,(function*(){var n;const d="onReceiveRequestCollateralMessage";r.isError?C.error({error:null===(n=r.getError())||void 0===n?void 0:n.message,method:d},"Error received"):(C.info({params:r.getValue(),method:d,from:t},"Handling message"),e[l.REQUEST_COLLATERAL_EVENT].post(Object.assign(Object.assign({},r.getValue()),{aliceIdentifier:I.publicIdentifier,bobIdentifier:t})),yield m.respondToRequestCollateralMessage(o,l.Result.ok({message:"Successfully requested collateral"})))})))),yield m.onReceiveSetupMessage(I.publicIdentifier,((e,r,t)=>n(this,void 0,void 0,(function*(){var n,o;const d="onReceiveSetupMessage";if(e.isError)return void C.error({error:null===(n=e.getError())||void 0===n?void 0:n.message,method:d},"Error received");const c=e.getValue();C.info({params:c,method:d},"Handling message");const f=yield T({chainId:c.chainId,counterpartyIdentifier:r,timeout:null!==(o=c.timeout)&&void 0!==o?o:l.DEFAULT_CHANNEL_TIMEOUT.toString(),meta:c.meta});yield m.respondToSetupMessage(t,f.isError?l.Result.fail(f.getError()):l.Result.ok({channelAddress:f.getValue().channelAddress}))})))),yield m.onReceiveWithdrawalQuoteMessage(I.publicIdentifier,((e,r,o)=>n(this,void 0,void 0,(function*(){var r;const n="onReceiveWithdrawalQuoteMessage",d=c.getRandomBytes32();if(C.info({method:n,methodId:d,quoteRequest:e.toJson()},"Method started"),e.isError)return void C.error({error:null===(r=e.getError())||void 0===r?void 0:r.message,method:n,methodId:d},"Error received");const l=e.getValue();C.info(Object.assign(Object.assign({},l),{method:n,methodId:d}),"Calculating quote");const f=yield y(l,N,I,w,t,C);yield m.respondToWithdrawalQuoteMessage(o,f),C.info({quote:f.toJson(),method:n,methodId:d},"Method complete")})))),t.on(l.EngineEvents.TRANSACTION_SUBMITTED,(data=>{e[l.EngineEvents.TRANSACTION_SUBMITTED].post(Object.assign(Object.assign({},data),{publicIdentifier:I.publicIdentifier}))})),t.on(l.EngineEvents.TRANSACTION_MINED,(data=>{e[l.EngineEvents.TRANSACTION_MINED].post(Object.assign(Object.assign({},data),{publicIdentifier:I.publicIdentifier}))})),t.on(l.EngineEvents.TRANSACTION_FAILED,(data=>{e[l.EngineEvents.TRANSACTION_FAILED].post(Object.assign(Object.assign({},data),{publicIdentifier:I.publicIdentifier}))}))}))},r.getWithdrawalQuote=y,r.resolveExistingWithdrawals=A;const R=(e,r,t)=>n(void 0,void 0,void 0,(function*(){const n=yield t.getRegisteredTransferByName(l.TransferNames.Withdraw,r[e.chainId].transferRegistryAddress,e.chainId);if(n.isError)return l.Result.fail(n.getError());const{definition:o}=n.getValue();return l.Result.ok(e.transferDefinition===o)}));r.resolveWithdrawal=(e,r,t,o,m,v,E,I,y)=>n(void 0,void 0,void 0,(function*(){var A;const R="resolveWithdrawal",w=c.getRandomBytes32(),{aliceIdentifier:S,bobIdentifier:C,channelAddress:T,balances:x,assetIds:U,alice:N,bob:O}=e;I.info({channelAddress:T,transferId:r.transferId,assetId:r.assetId,method:R,methodId:w},"Started");const{meta:meta,assetId:P,initiatorIdentifier:F,transferId:j,transferState:{nonce:k,initiatorSignature:_,fee:D,initiator:M,responder:V,callTo:B,callData:L,balance:W}}=r,H=null!==(A=meta.initiatorSubmits)&&void 0!==A&&A,G=W.amount.reduce(((e,r)=>e.add(r)),h.BigNumber.from(0)).sub(D);I.debug({withdrawalAmount:G.toString(),initiator:M,responder:V,fee:D},"Withdrawal info");const Q=U.findIndex((a=>f.getAddress(a)===f.getAddress(P))),$={aliceIdentifier:S,bobIdentifier:C,assetId:P,amount:G.toString(),fee:D,recipient:W.to[0],channelBalance:x[Q],channelAddress:T,transfer:r,callTo:B,callData:L};if(o[l.EngineEvents.WITHDRAWAL_CREATED].post($),F===v.publicIdentifier)return void I.info({method:R},"Waiting for counterparty sig");const Z=1===r.chainId||c.TESTNETS_WITH_FEES.includes(r.chainId);if(100!==y&&v.address===e.alice&&Z&&!H){const o=e=>n(void 0,void 0,void 0,(function*(){I.warn({cancellationReason:e,transferId:j,channelAddress:T,method:R,methodId:w},"Cancelling withdrawal");const r=yield t.resolve({transferResolver:{responderSignature:c.mkSig("0x0")},transferId:j,channelAddress:T,meta:Object.assign(Object.assign({},null!=meta?meta:{}),{cancellationReason:e})});r.isError&&I.error({method:R,error:r.getError().message,transferId:j,channelAddress:T,transactionHash:X},"Failed to cancel withdrawal")})),{quote:d}=null!=meta?meta:{};if(!d)return void(yield o("Missing withdrawal quote"));if(parseInt(d.expiry)<Date.now())return void(yield o("Withdrawal quote expired, please retry"));try{const t={channelAddress:r.channelAddress,amount:G.toString(),assetId:P,fee:D,expiry:d.expiry},n=yield c.recoverAddressFromChannelMessage(c.hashWithdrawalQuote(t),d.signature);if(n!==e.alice)throw new Error(`Got ${n} expected ${e.alice} on ${c.safeJsonStringify(t)}. (Quote: ${c.safeJsonStringify(d)})`)}catch(e){return void(yield o(`Withdrawal quote recovery failed: ${e.message}`))}I.info({quote:d,method:R,methodId:w},"Withdrawal fees verified")}const z=new d.WithdrawCommitment(T,N,O,W.to[0],P,G.toString(),k,B,L),J=yield v.signMessage(z.hashToSign());let X;if(yield z.addSignatures(_,J),v.address===N&&!H){I.info({method:R,withdrawalAmount:G.toString(),channelAddress:T},"Submitting withdrawal to chain");const r=yield E.sendWithdrawTx(e,z.getSignedTransaction());r.isError?I.error({error:r.getError().message,method:R},"Failed to submit tx"):(X=r.getValue().hash,I.info({method:R,transactionHash:X},"Submitted tx"),o[l.WITHDRAWAL_RECONCILED_EVENT].post({aliceIdentifier:S,bobIdentifier:C,channelAddress:T,transferId:j,transactionHash:X}))}z.addTransaction(X),yield m.saveWithdrawalCommitment(r.transferId,z.toJson());const Y=Object.assign({transactionHash:X},null!=meta?meta:{}),K=yield t.resolve({transferResolver:{responderSignature:J},transferId:j,channelAddress:T,meta:Y});K.isError?I.error({method:R,error:K.getError().message,transferId:j,channelAddress:T,transactionHash:X},"Failed to resolve"):I.info({method:R,amount:G.toString(),assetId:r.assetId,fee:D,transactionHash:X},"Withdrawal resolved")}))},2906:function(e,r,t){"use strict";var n=this&&this.__awaiter||function(e,r,t,n){return new(t||(t=Promise))((function(o,d){function l(e){try{f(n.next(e))}catch(e){d(e)}}function c(e){try{f(n.throw(e))}catch(e){d(e)}}function f(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(l,c)}f((n=n.apply(e,r||[])).next())}))};Object.defineProperty(r,"__esModule",{value:!0}),r.sendIsAlive=void 0;const o=t(27),d=t(50);r.sendIsAlive=function(e,r,t,l,c){return n(this,void 0,void 0,(function*(){const f="sendIsAlive",h=yield t.getChannelStates(),m=l.getChainProviders();if(m.isError)return void c.error(Object.assign(Object.assign({},m.getError()),{method:f}),"Error getting chain providers");const v=Object.keys(m.getValue()).map((e=>parseInt(e)));c.info({method:f,numChannels:h.length},"Sending check-in messages"),yield Promise.all(h.map((t=>n(this,void 0,void 0,(function*(){var n,l;if(!v.includes(t.networkContext.chainId))return void c.debug({chainId:t.networkContext.chainId,supportedChains:v,method:f,channelAddress:t.channelAddress},"Channel chain not supported, skipping");const h=d.getParticipant(t,e.publicIdentifier);if(!h)return void c.error({participant:h,alice:t.aliceIdentifier,bob:t.bobIdentifier,channel:t.channelAddress},"Signer not in channel");const m="alice"===h?t.bobIdentifier:t.aliceIdentifier,E=yield r.sendIsAliveMessage(o.Result.ok({channelAddress:t.channelAddress}),m,e.publicIdentifier);E.isError?c.error({method:f,counterpartyIdentifier:m,channel:t.channelAddress,error:null===(n=E.getError())||void 0===n?void 0:n.message,context:null===(l=E.getError())||void 0===l?void 0:l.context},"Error sending checkIn message"):c.info({method:f,counterpartyIdentifier:m,channel:t.channelAddress,result:E.getValue()},"Successfully sent checkIn message")})))))}))}},3157:function(e,r,t){"use strict";t.r(r),t.d(r,"AddressZero",(function(){return n})),t.d(r,"NegativeOne",(function(){return d})),t.d(r,"Zero",(function(){return l})),t.d(r,"One",(function(){return c})),t.d(r,"Two",(function(){return f})),t.d(r,"WeiPerEther",(function(){return h})),t.d(r,"MaxUint256",(function(){return m})),t.d(r,"HashZero",(function(){return v})),t.d(r,"EtherSymbol",(function(){return E}));const n="0x0000000000000000000000000000000000000000";var o=t(135);const d=o.a.from(-1),l=o.a.from(0),c=o.a.from(1),f=o.a.from(2),h=o.a.from("1000000000000000000"),m=o.a.from("0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"),v="0x0000000000000000000000000000000000000000000000000000000000000000",E="Îž"},472:function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.ApplyUpdateError=r.CreateUpdateError=r.OutboundChannelUpdateError=r.InboundChannelUpdateError=r.ValidationError=void 0;const n=t(27);class o extends n.ProtocolError{constructor(e,r,t,n={}){super(e,t,Object.keys(r).includes("fromIdentifier")?r:void 0,Object.keys(r).includes("fromIdentifier")?void 0:r,n,o.type),this.message=e}}r.ValidationError=o,o.type="ValidationError",o.reasons={AssetNotFound:"Asset is not found in channel",ChannelAlreadySetup:"Channel is already setup",ChannelNotFound:"No channel found in storage",ChainServiceFailure:"Failed to execute chain service method",DuplicateTransferId:"Transfer with matching transferId already stored",InDispute:"Channel currently in dispute",InsufficientFunds:"Insufficient funds in channel",InvalidArrayLength:"Channel array values have mismatching lengths (balances, assetIds, defundNonces, processedDepositsA/B)",InvalidAssetId:"Asset ID is invalid",InvalidChannelAddress:"Provided channel address is invalid",InvalidCounterparty:"Channel counterparty is invalid",InvalidInitialState:"Initial transfer state is invalid",InvalidResolver:"Transfer resolver must be an object",LongChannelTimeout:`Channel timeout above maximum of ${n.MAXIMUM_CHANNEL_TIMEOUT.toString()}s`,OnlyResponderCanInitiateResolve:"Only transfer responder may initiate resolve update",ShortChannelTimeout:`Channel timeout below minimum of ${n.MINIMUM_CHANNEL_TIMEOUT.toString()}s`,TooManyAssets:"20 or more assets already in channel state",TransferNotActive:"Transfer not found in activeTransfers",TransferResolved:"Transfer has already been resolved",TransferTimeoutAboveChannel:"Transfer timeout must be less than the channel timeout",TransferTimeoutBelowMin:`Transfer timeout below minimum of ${n.MINIMUM_TRANSFER_TIMEOUT.toString()}s`,TransferTimeoutAboveMax:`Transfer timeout above maximum of ${n.MAXIMUM_TRANSFER_TIMEOUT.toString()}s`,UnrecognizedType:"Unrecognized update type"};class d extends n.ProtocolError{constructor(e,r,t,n={}){super(e,t,r,void 0,n,d.type),this.message=e}}r.InboundChannelUpdateError=d,d.type="InboundChannelUpdateError",d.reasons={ApplyAndValidateInboundFailed:"Failed to validate + apply incoming update",ApplyUpdateFailed:"Failed to apply update",BadSignatures:"Could not recover signers",CannotSyncSetup:"Cannot sync a setup update, must restore",CouldNotGetParams:"Could not generate params from update",CouldNotGetFinalBalance:"Could not retrieve resolved balance from chain",GenerateSignatureFailed:"Failed to generate channel signature",ExternalValidationFailed:"Failed external inbound validation",InvalidUpdateNonce:"Update nonce must be previousState.nonce + 1",MalformedDetails:"Channel update details are malformed",MalformedUpdate:"Channel update is malformed",RestoreNeeded:"Cannot sync channel from counterparty, must restore",SaveChannelFailed:"Failed to save channel",StoreFailure:"Failed to pull data from store",StaleChannel:"Channel state is behind, cannot apply update",StaleUpdate:"Update does not progress channel nonce",SyncFailure:"Failed to sync channel from counterparty update",TransferNotActive:"Transfer not found in activeTransfers"};class l extends n.ProtocolError{constructor(e,r,t,n={}){super(e,t,void 0,r,n,l.type),this.message=e}}r.OutboundChannelUpdateError=l,l.type="OutboundChannelUpdateError",l.reasons={AcquireLockFailed:"Failed to acquire lock",BadSignatures:"Could not recover signers",CannotSyncSetup:"Cannot sync a setup update, must restore",ChannelNotFound:"No channel found in storage",CounterpartyFailure:"Counterparty failed to apply update",CounterpartyOffline:"Message to counterparty timed out",Create2Failed:"Failed to get create2 address",ExternalValidationFailed:"Failed external outbound validation",GenerateUpdateFailed:"Failed to generate update",InvalidParams:"Invalid params",NoUpdateToSync:"No update provided from responder to sync from",OutboundValidationFailed:"Failed to validate outbound update",RegenerateUpdateFailed:"Failed to regenerate update after sync",ReleaseLockFailed:"Failed to release lock",RestoreNeeded:"Cannot sync channel from counterparty, must restore",SaveChannelFailed:"Failed to save channel",StaleChannel:"Channel state is behind, cannot apply update",StoreFailure:"Failed to pull data from store",SyncFailure:"Failed to sync channel from counterparty update"};class c extends n.ProtocolError{constructor(e,r,t,n={}){super(e,t,void 0,r,n,c.type),this.message=e}}r.CreateUpdateError=c,c.type="CreateUpdateError",c.reasons={BadUpdateType:"Cannot generate unrecognized update type",CouldNotApplyUpdate:"Failed to apply update to generate sig",CouldNotSign:"Failed to sign updated channel hash",FailedToReconcileDeposit:"Could not reconcile deposit",FailedToResolveTransferOnchain:"Could not resolve transfer onchain",TransferNotActive:"Transfer not found in active transfers",TransferNotRegistered:"Transfer not found in registry"};class f extends n.ProtocolError{constructor(e,r,t,n={}){super(e,t,r,void 0,n,f.type),this.message=e}}r.ApplyUpdateError=f,f.type="ApplyUpdateError",f.reasons={BadUpdateType:"Cannot apply unrecognized update type",ChannelNotFound:"Channel not found",MissingFinalBalance:"Final balance not provided for applying resolve update",TransferNotActive:"Transfer not found in active transfers"}},473:function(e,r,t){"use strict";var n=this&&this.__awaiter||function(e,r,t,n){return new(t||(t=Promise))((function(o,d){function l(e){try{f(n.next(e))}catch(e){d(e)}}function c(e){try{f(n.throw(e))}catch(e){d(e)}}function f(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(l,c)}f((n=n.apply(e,r||[])).next())}))},o=this&&this.__rest||function(s,e){var r={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(r[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(r[p[i]]=s[p[i]])}return r},d=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.mergeAssetIds=r.getUpdatedChannelBalance=r.reconcileDeposit=r.generateSignedChannelCommitment=r.getParamsFromUpdate=r.extractContextFromStore=r.validateChannelSignatures=r.validateSchema=void 0;const l=t(27),c=t(32),f=t(654),h=t(50),m=new(d(t(629)).default);r.validateSchema=(e,r)=>{var t;const n=m.compile(r);if(!n(e))return null===(t=n.errors)||void 0===t?void 0:t.map((e=>e.message)).join()},r.validateChannelSignatures=function(e,r,t,o,d){return n(this,void 0,void 0,(function*(){return h.validateChannelUpdateSignatures(e,r,t,o,d)}))};r.extractContextFromStore=(e,r)=>n(void 0,void 0,void 0,(function*(){let t,n,o="getChannelState";try{n=yield e.getChannelState(r),o="getActiveTransfers",t=yield e.getActiveTransfers(r)}catch(e){return l.Result.fail(new Error(`${o} failed: ${e.message}`))}return l.Result.ok({activeTransfers:t,channelState:n})})),r.getParamsFromUpdate=function(e){var r;const{channelAddress:t,type:n,details:details,toIdentifier:o,assetId:d}=e;let c;switch(n){case"setup":{const{networkContext:e,timeout:r,meta:meta}=details;c={networkContext:Object.assign({},e),timeout:r,counterpartyIdentifier:o,meta:null!=meta?meta:{}};break}case"deposit":c={channelAddress:t,assetId:d,meta:null!==(r=details.meta)&&void 0!==r?r:{}};break;case"create":{const{balance:e,transferInitialState:r,transferDefinition:n,transferTimeout:o,meta:meta}=details;c={balance:e,channelAddress:t,assetId:d,transferDefinition:n,transferInitialState:r,timeout:o,meta:null!=meta?meta:{}};break}case"resolve":{const{transferResolver:e,transferId:r,meta:meta}=details;c={channelAddress:t,transferId:r,transferResolver:e,meta:null!=meta?meta:{}};break}default:return l.Result.fail(new Error(`Invalid update type ${n}`))}return l.Result.ok({channelAddress:t,type:n,details:c})},r.generateSignedChannelCommitment=function(e,r,t,d,c){return n(this,void 0,void 0,(function*(){const n=(e,details={},r="info")=>{c&&c[r](details,e)},{networkContext:f}=e,m=o(e,["networkContext"]),v=h.hashChannelCommitment(m);if(t&&d)return n("Double signed, doing nothing",{aliceSignature:t,bobSignature:d,hash:v}),l.Result.ok({core:m,aliceSignature:t,bobSignature:d});try{n("Signing hash",{hash:v,signer:r.address,state:e},"debug");const o=yield r.signMessage(v),c=r.address===e.alice;return l.Result.ok({core:m,aliceSignature:c?o:t,bobSignature:c?d:o})}catch(e){return l.Result.fail(e)}}))};r.reconcileDeposit=(e,r,t,o,d,c,h)=>n(void 0,void 0,void 0,(function*(){const n=yield h.getTotalDepositedA(e,r,c);if(n.isError)return l.Result.fail(n.getError());const m=n.getValue(),v=yield h.getTotalDepositedB(e,r,c);if(v.isError)return l.Result.fail(v.getError());const E=v.getValue(),I=[f.BigNumber.from(m).sub(o),f.BigNumber.from(E).sub(d)],y=Object.assign(Object.assign({},t),{amount:[f.BigNumber.from(t.amount[0]).add(I[0]).toString(),f.BigNumber.from(t.amount[1]).add(I[1]).toString()]});return l.Result.ok({balance:y,totalDepositsAlice:m.toString(),totalDepositsBob:E.toString()})}));r.getUpdatedChannelBalance=(e,r,t,n,o)=>{const d=n.assetIds.findIndex((a=>c.getAddress(a)===c.getAddress(r)));if(-1===d)throw new Error(`Asset id not found in channel ${r}`);const h=n.balances[d]||{to:[n.alice,n.bob],amount:["0","0"]},m=(r,t)=>e===l.UpdateType.create?f.BigNumber.from(r).sub(t).toString():f.BigNumber.from(r).add(t).toString(),v=o===n.alice?t.amount[0]:t.amount[1],E=o===n.bob?t.amount[0]:t.amount[1];return{to:[...h.to],amount:[m(h.amount[0],v),m(h.amount[1],E)]}};r.mergeAssetIds=e=>{const r=[],t=[],n=[],o=[],d=[];return e.assetIds.forEach(((l,h)=>{const m=e.assetIds.filter(((a,i)=>a.toLowerCase()===l.toLowerCase()&&i!==h)),v=c.getAddress(l);if(0===m.length)return r[h]=v,t[h]=e.processedDepositsA[h],n[h]=e.processedDepositsB[h],o[h]=e.balances[h],void(d[h]=e.defundNonces[h]);const E=a=>a.toLowerCase()===l.toLowerCase()&&!r.includes(v),I=e.processedDepositsA.reduce(((r,t,n)=>f.BigNumber.from(r).add(E(e.assetIds[n])?t:"0").toString()),"0"),y=e.processedDepositsB.reduce(((r,t,n)=>f.BigNumber.from(r).add(E(e.assetIds[n])?t:"0").toString()),"0"),A=e.balances.reduce(((r,t,n)=>{if(E(e.assetIds[n])){const e=[f.BigNumber.from(r.amount[0]).add(t.amount[0]),f.BigNumber.from(r.amount[1]).add(t.amount[1])].map((e=>e.toString()));return{to:r.to,amount:e}}return r}),{to:[e.alice,e.bob],amount:["0","0"]}),R=e.defundNonces.reduce(((r,t,n)=>E(e.assetIds[n])&&r>t?r:t),"0");E(l)&&(r[h]=c.getAddress(l),t[h]=I,n[h]=y,o[h]=A,d[h]=R)})),Object.assign(Object.assign({},e),{assetIds:r,processedDepositsA:t,processedDepositsB:n,balances:o,defundNonces:d})}},487:function(e,r,t){"use strict";t.r(r),t.d(r,"BigNumber",(function(){return n.a})),t.d(r,"formatFixed",(function(){return y})),t.d(r,"FixedFormat",(function(){return R})),t.d(r,"FixedNumber",(function(){return w})),t.d(r,"parseFixed",(function(){return A})),t.d(r,"_base16To36",(function(){return n.b})),t.d(r,"_base36To16",(function(){return n.c}));var n=t(136),o=t(93),d=t(2),l=t(514);const c=new d.b(l.a),f={},h=n.a.from(0),m=n.a.from(-1);function v(e,r,t,n){const o={fault:r,operation:t};return void 0!==n&&(o.value=n),c.throwError(e,d.b.errors.NUMERIC_FAULT,o)}let E="0";for(;E.length<256;)E+=E;function I(e){if("number"!=typeof e)try{e=n.a.from(e).toNumber()}catch(e){}return"number"==typeof e&&e>=0&&e<=256&&!(e%1)?"1"+E.substring(0,e):c.throwArgumentError("invalid decimal size","decimals",e)}function y(e,r){null==r&&(r=0);const t=I(r),o=(e=n.a.from(e)).lt(h);o&&(e=e.mul(m));let d=e.mod(t).toString();for(;d.length<t.length-1;)d="0"+d;d=d.match(/^([0-9]*[1-9]|0)(0*)/)[1];const l=e.div(t).toString();return e=l+"."+d,o&&(e="-"+e),e}function A(e,r){null==r&&(r=0);const t=I(r);if("string"==typeof e&&e.match(/^-?[0-9.,]+$/)||c.throwArgumentError("invalid decimal value","value",e),t.length-1==0)return n.a.from(e);const o="-"===e.substring(0,1);o&&(e=e.substring(1)),"."===e&&c.throwArgumentError("missing value","value",e);const d=e.split(".");d.length>2&&c.throwArgumentError("too many decimal points","value",e);let l=d[0],f=d[1];for(l||(l="0"),f||(f="0"),f.length>t.length-1&&v("fractional component exceeds decimals","underflow","parseFixed");f.length<t.length-1;)f+="0";const h=n.a.from(l),E=n.a.from(f);let y=h.mul(t).add(E);return o&&(y=y.mul(m)),y}class R{constructor(e,r,t,n){e!==f&&c.throwError("cannot use FixedFormat constructor; use FixedFormat.from",d.b.errors.UNSUPPORTED_OPERATION,{operation:"new FixedFormat"}),this.signed=r,this.width=t,this.decimals=n,this.name=(r?"":"u")+"fixed"+String(t)+"x"+String(n),this._multiplier=I(n),Object.freeze(this)}static from(e){if(e instanceof R)return e;let r=!0,t=128,n=18;if("string"==typeof e){if("fixed"===e);else if("ufixed"===e)r=!1;else if(null!=e){const o=e.match(/^(u?)fixed([0-9]+)x([0-9]+)$/);o||c.throwArgumentError("invalid fixed format","format",e),r="u"!==o[1],t=parseInt(o[2]),n=parseInt(o[3])}}else if(e){const o=(r,t,n)=>null==e[r]?n:(typeof e[r]!==t&&c.throwArgumentError("invalid fixed format ("+r+" not "+t+")","format."+r,e[r]),e[r]);r=o("signed","boolean",r),t=o("width","number",t),n=o("decimals","number",n)}return t%8&&c.throwArgumentError("invalid fixed format width (not byte aligned)","format.width",t),n>80&&c.throwArgumentError("invalid fixed format (decimals too large)","format.decimals",n),new R(f,r,t,n)}}class w{constructor(e,r,t,n){c.checkNew(new.target,w),e!==f&&c.throwError("cannot use FixedNumber constructor; use FixedNumber.from",d.b.errors.UNSUPPORTED_OPERATION,{operation:"new FixedFormat"}),this.format=n,this._hex=r,this._value=t,this._isFixedNumber=!0,Object.freeze(this)}_checkFormat(e){this.format.name!==e.format.name&&c.throwArgumentError("incompatible format; use fixedNumber.toFormat","other",e)}addUnsafe(e){this._checkFormat(e);const a=A(this._value,this.format.decimals),b=A(e._value,e.format.decimals);return w.fromValue(a.add(b),this.format.decimals,this.format)}subUnsafe(e){this._checkFormat(e);const a=A(this._value,this.format.decimals),b=A(e._value,e.format.decimals);return w.fromValue(a.sub(b),this.format.decimals,this.format)}mulUnsafe(e){this._checkFormat(e);const a=A(this._value,this.format.decimals),b=A(e._value,e.format.decimals);return w.fromValue(a.mul(b).div(this.format._multiplier),this.format.decimals,this.format)}divUnsafe(e){this._checkFormat(e);const a=A(this._value,this.format.decimals),b=A(e._value,e.format.decimals);return w.fromValue(a.mul(this.format._multiplier).div(b),this.format.decimals,this.format)}floor(){let e=this.toString().split("."),r=w.from(e[0],this.format);const t=!e[1].match(/^(0*)$/);return this.isNegative()&&t&&(r=r.subUnsafe(S)),r}ceiling(){let e=this.toString().split("."),r=w.from(e[0],this.format);const t=!e[1].match(/^(0*)$/);return!this.isNegative()&&t&&(r=r.addUnsafe(S)),r}round(e){null==e&&(e=0);let r=this.toString().split(".");if((e<0||e>80||e%1)&&c.throwArgumentError("invalid decimal count","decimals",e),r[1].length<=e)return this;const t=w.from("1"+E.substring(0,e));return this.mulUnsafe(t).addUnsafe(C).floor().divUnsafe(t)}isZero(){return"0.0"===this._value}isNegative(){return"-"===this._value[0]}toString(){return this._value}toHexString(e){if(null==e)return this._hex;e%8&&c.throwArgumentError("invalid byte width","width",e);const r=n.a.from(this._hex).fromTwos(this.format.width).toTwos(e).toHexString();return Object(o.e)(r,e/8)}toUnsafeFloat(){return parseFloat(this.toString())}toFormat(e){return w.fromString(this._value,e)}static fromValue(e,r,t){return null!=t||null==r||Object(n.d)(r)||(t=r,r=null),null==r&&(r=0),null==t&&(t="fixed"),w.fromString(y(e,r),R.from(t))}static fromString(e,r){null==r&&(r="fixed");const t=R.from(r),n=A(e,t.decimals);!t.signed&&n.lt(h)&&v("unsigned value cannot be negative","overflow","value",e);let d=null;t.signed?d=n.toTwos(t.width).toHexString():(d=n.toHexString(),d=Object(o.e)(d,t.width/8));const l=y(n,t.decimals);return new w(f,d,l,t)}static fromBytes(e,r){null==r&&(r="fixed");const t=R.from(r);if(Object(o.a)(e).length>t.width/8)throw new Error("overflow");let d=n.a.from(e);t.signed&&(d=d.fromTwos(t.width));const l=d.toTwos((t.signed?0:1)+t.width).toHexString(),c=y(d,t.decimals);return new w(f,l,c,t)}static from(e,r){if("string"==typeof e)return w.fromString(e,r);if(Object(o.g)(e))return w.fromBytes(e,r);try{return w.fromValue(e,0,r)}catch(e){if(e.code!==d.b.errors.INVALID_ARGUMENT)throw e}return c.throwArgumentError("invalid FixedNumber value","value",e)}static isFixedNumber(e){return!(!e||!e._isFixedNumber)}}const S=w.from(1),C=w.from("0.5")},513:function(e,r,t){"use strict";t.d(r,"a",(function(){return n}));const n="bignumber/5.0.14"},514:function(e,r,t){"use strict";t.d(r,"a",(function(){return n}));const n="bignumber/5.0.14"},641:function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.WithdrawQuoteError=r.RpcError=r.ParameterConversionError=r.IsAliveError=r.RestoreError=r.CheckInError=r.DisputeError=void 0;const n=t(27);class o extends n.EngineError{constructor(e,r,t,n={}){super(e,r,t,n,o.type),this.message=e}}r.DisputeError=o,o.type="DisputeError",o.reasons={ChannelDefundTxFailed:"Failed to send defund channel tx",ChannelDisputeTxFailed:"Failed to send dispute channel tx",ChannelNotInDispute:"Channel is not in dispute",ChannelNotFound:"Channel not found",CouldNotGetActiveTransfers:"Failed to retrieve active transfers from store",CouldNotGetChannel:"Failed to retrieve channel from store",CouldNotGetTransfer:"Failed to retrieve transfer from store",TransferNotFound:"Transfer not found",TransferNotDisputed:"Transfer not in dispute",TransferDefundTxFailed:"Failed to send defund transfer tx",TransferDisputeTxFailed:"Failed to send dispute transfer tx",Unknown:"Unknown dispute error"};class d extends n.EngineError{constructor(e,r,t,n={}){super(e,r,t,n,d.type),this.message=e}}r.CheckInError=d,d.type="CheckInError",d.reasons={ChannelNotFound:"Channel not found",Unknown:"Unknown check-in error"};class l extends n.EngineError{constructor(e,r,t,n={}){super(e,r,t,n,l.type),this.message=e}}r.RestoreError=l,l.type="RestoreError",l.reasons={AckFailed:"Could not send restore ack",AcquireLockError:"Failed to acquire restore lock",ChannelNotFound:"Channel not found",CouldNotGetActiveTransfers:"Failed to retrieve active transfers from store",CouldNotGetChannel:"Failed to retrieve channel from store",GetChannelAddressFailed:"Failed to calculate channel address for verification",InvalidChannelAddress:"Failed to verify channel address",InvalidMerkleRoot:"Failed to validate merkleRoot for restoration",InvalidSignatures:"Failed to validate sigs on latestUpdate",NoData:"No data sent from counterparty to restore",ReceivedError:"Got restore error from counterparty",ReleaseLockError:"Failed to release restore lock",SaveChannelFailed:"Failed to save channel state",SyncableState:"Cannot restore, state is syncable. Try reconcileDeposit"};class c extends n.EngineError{constructor(e,r,t,n={}){super(e,r,t,n,c.type),this.message=e}}r.IsAliveError=c,c.type="IsAliveError",c.reasons={ChannelNotFound:"Channel not found",Unknown:"Unknown isAlive error"};class f extends n.EngineError{constructor(e,r,t,n={}){super(e,r,t,n,f.type),this.message=e}}r.ParameterConversionError=f,f.type="ParameterConversionError",f.reasons={BobDoesntSubmitAlice:"Bob cannot submit Alice's withdrawals",CannotSendToSelf:"An initiator cannot be a receiver on the same chain",CouldNotGetQuote:"Failed to get quote",CouldNotSignWithdrawal:"Failed to sign withdrawal commitment",FailedToGetRegisteredTransfer:"Could not get transfer registry information",FeeGreaterThanAmount:"Fees charged are greater than amount",NoOp:"Cannot create withdrawal with 0 amount and no call",WithdrawToZero:"Cannot withdraw to AddressZero"};class h extends n.EngineError{constructor(e,r,t,n={}){super(e,r,t,n,h.type),this.message=e}}r.RpcError=h,h.type="RpcError",h.reasons={ChainServiceFailure:"Failed to execute chain service method",ChannelNotFound:"Channel not found",DecryptFailed:"Failed to decrypt",EngineMethodFailure:"Failed to execute engine method",InvalidParams:"Parameters from rpc request are malformed",InvalidRpcSchema:"Rpc request is malformed",InvalidMethod:"Rpc method is invalid",ParamConversionFailed:"Failed to convert engine ",ProtocolMethodFailed:"Failed to execute protocol method",SignerNotInChannel:"Signer is not in channel",StoreMethodFailed:"Failed to execute store method",TransferNotFound:"Transfer not found",SigningFailed:"Failed to sign message",UtilitySigningFailed:"Failed to sign utility message"};class m extends n.EngineError{constructor(e,r,t,n={}){super(e,t.channelAddress,r,n,m.type),this.message=e}}r.WithdrawQuoteError=m,m.type="WithdrawQuoteError",m.reasons={ChannelNotFound:"Channel not found",ChainServiceFailure:"Chain service method failed",ExchangeRateError:"Calculating exchange failed",SignatureFailure:"Signing quote failed"}},654:function(e,r,t){"use strict";t.r(r),t.d(r,"BigNumber",(function(){return n.a})),t.d(r,"formatFixed",(function(){return y})),t.d(r,"FixedFormat",(function(){return R})),t.d(r,"FixedNumber",(function(){return w})),t.d(r,"parseFixed",(function(){return A})),t.d(r,"_base16To36",(function(){return n.b})),t.d(r,"_base36To16",(function(){return n.c}));var n=t(135),o=t(1),d=t(2),l=t(513);const c=new d.b(l.a),f={},h=n.a.from(0),m=n.a.from(-1);function v(e,r,t,n){const o={fault:r,operation:t};return void 0!==n&&(o.value=n),c.throwError(e,d.b.errors.NUMERIC_FAULT,o)}let E="0";for(;E.length<256;)E+=E;function I(e){if("number"!=typeof e)try{e=n.a.from(e).toNumber()}catch(e){}return"number"==typeof e&&e>=0&&e<=256&&!(e%1)?"1"+E.substring(0,e):c.throwArgumentError("invalid decimal size","decimals",e)}function y(e,r){null==r&&(r=0);const t=I(r),o=(e=n.a.from(e)).lt(h);o&&(e=e.mul(m));let d=e.mod(t).toString();for(;d.length<t.length-1;)d="0"+d;d=d.match(/^([0-9]*[1-9]|0)(0*)/)[1];const l=e.div(t).toString();return e=l+"."+d,o&&(e="-"+e),e}function A(e,r){null==r&&(r=0);const t=I(r);if("string"==typeof e&&e.match(/^-?[0-9.,]+$/)||c.throwArgumentError("invalid decimal value","value",e),t.length-1==0)return n.a.from(e);const o="-"===e.substring(0,1);o&&(e=e.substring(1)),"."===e&&c.throwArgumentError("missing value","value",e);const d=e.split(".");d.length>2&&c.throwArgumentError("too many decimal points","value",e);let l=d[0],f=d[1];for(l||(l="0"),f||(f="0"),f.length>t.length-1&&v("fractional component exceeds decimals","underflow","parseFixed");f.length<t.length-1;)f+="0";const h=n.a.from(l),E=n.a.from(f);let y=h.mul(t).add(E);return o&&(y=y.mul(m)),y}class R{constructor(e,r,t,n){e!==f&&c.throwError("cannot use FixedFormat constructor; use FixedFormat.from",d.b.errors.UNSUPPORTED_OPERATION,{operation:"new FixedFormat"}),this.signed=r,this.width=t,this.decimals=n,this.name=(r?"":"u")+"fixed"+String(t)+"x"+String(n),this._multiplier=I(n),Object.freeze(this)}static from(e){if(e instanceof R)return e;let r=!0,t=128,n=18;if("string"==typeof e){if("fixed"===e);else if("ufixed"===e)r=!1;else if(null!=e){const o=e.match(/^(u?)fixed([0-9]+)x([0-9]+)$/);o||c.throwArgumentError("invalid fixed format","format",e),r="u"!==o[1],t=parseInt(o[2]),n=parseInt(o[3])}}else if(e){const o=(r,t,n)=>null==e[r]?n:(typeof e[r]!==t&&c.throwArgumentError("invalid fixed format ("+r+" not "+t+")","format."+r,e[r]),e[r]);r=o("signed","boolean",r),t=o("width","number",t),n=o("decimals","number",n)}return t%8&&c.throwArgumentError("invalid fixed format width (not byte aligned)","format.width",t),n>80&&c.throwArgumentError("invalid fixed format (decimals too large)","format.decimals",n),new R(f,r,t,n)}}class w{constructor(e,r,t,n){c.checkNew(new.target,w),e!==f&&c.throwError("cannot use FixedNumber constructor; use FixedNumber.from",d.b.errors.UNSUPPORTED_OPERATION,{operation:"new FixedFormat"}),this.format=n,this._hex=r,this._value=t,this._isFixedNumber=!0,Object.freeze(this)}_checkFormat(e){this.format.name!==e.format.name&&c.throwArgumentError("incompatible format; use fixedNumber.toFormat","other",e)}addUnsafe(e){this._checkFormat(e);const a=A(this._value,this.format.decimals),b=A(e._value,e.format.decimals);return w.fromValue(a.add(b),this.format.decimals,this.format)}subUnsafe(e){this._checkFormat(e);const a=A(this._value,this.format.decimals),b=A(e._value,e.format.decimals);return w.fromValue(a.sub(b),this.format.decimals,this.format)}mulUnsafe(e){this._checkFormat(e);const a=A(this._value,this.format.decimals),b=A(e._value,e.format.decimals);return w.fromValue(a.mul(b).div(this.format._multiplier),this.format.decimals,this.format)}divUnsafe(e){this._checkFormat(e);const a=A(this._value,this.format.decimals),b=A(e._value,e.format.decimals);return w.fromValue(a.mul(this.format._multiplier).div(b),this.format.decimals,this.format)}floor(){let e=this.toString().split("."),r=w.from(e[0],this.format);const t=!e[1].match(/^(0*)$/);return this.isNegative()&&t&&(r=r.subUnsafe(S)),r}ceiling(){let e=this.toString().split("."),r=w.from(e[0],this.format);const t=!e[1].match(/^(0*)$/);return!this.isNegative()&&t&&(r=r.addUnsafe(S)),r}round(e){null==e&&(e=0);let r=this.toString().split(".");if((e<0||e>80||e%1)&&c.throwArgumentError("invalid decimal count","decimals",e),r[1].length<=e)return this;const t=w.from("1"+E.substring(0,e));return this.mulUnsafe(t).addUnsafe(C).floor().divUnsafe(t)}isZero(){return"0.0"===this._value}isNegative(){return"-"===this._value[0]}toString(){return this._value}toHexString(e){if(null==e)return this._hex;e%8&&c.throwArgumentError("invalid byte width","width",e);const r=n.a.from(this._hex).fromTwos(this.format.width).toTwos(e).toHexString();return Object(o.h)(r,e/8)}toUnsafeFloat(){return parseFloat(this.toString())}toFormat(e){return w.fromString(this._value,e)}static fromValue(e,r,t){return null!=t||null==r||Object(n.d)(r)||(t=r,r=null),null==r&&(r=0),null==t&&(t="fixed"),w.fromString(y(e,r),R.from(t))}static fromString(e,r){null==r&&(r="fixed");const t=R.from(r),n=A(e,t.decimals);!t.signed&&n.lt(h)&&v("unsigned value cannot be negative","overflow","value",e);let d=null;t.signed?d=n.toTwos(t.width).toHexString():(d=n.toHexString(),d=Object(o.h)(d,t.width/8));const l=y(n,t.decimals);return new w(f,d,l,t)}static fromBytes(e,r){null==r&&(r="fixed");const t=R.from(r);if(Object(o.a)(e).length>t.width/8)throw new Error("overflow");let d=n.a.from(e);t.signed&&(d=d.fromTwos(t.width));const l=d.toTwos((t.signed?0:1)+t.width).toHexString(),c=y(d,t.decimals);return new w(f,l,c,t)}static from(e,r){if("string"==typeof e)return w.fromString(e,r);if(Object(o.j)(e))return w.fromBytes(e,r);try{return w.fromValue(e,0,r)}catch(e){if(e.code!==d.b.errors.INVALID_ARGUMENT)throw e}return c.throwArgumentError("invalid FixedNumber value","value",e)}static isFixedNumber(e){return!(!e||!e._isFixedNumber)}}const S=w.from(1),C=w.from("0.5")},93:function(e,r,t){"use strict";t.d(r,"g",(function(){return l})),t.d(r,"a",(function(){return c})),t.d(r,"b",(function(){return f})),t.d(r,"i",(function(){return h})),t.d(r,"h",(function(){return m})),t.d(r,"f",(function(){return E})),t.d(r,"c",(function(){return I})),t.d(r,"d",(function(){return y})),t.d(r,"e",(function(){return A}));const n=new(t(2).b)("bytes/5.0.10");function o(e){return!!e.toHexString}function d(e){return e.slice||(e.slice=function(){const r=Array.prototype.slice.call(arguments);return d(new Uint8Array(Array.prototype.slice.apply(e,r)))}),e}function l(e){if(null==e)return!1;if(e.constructor===Uint8Array)return!0;if("string"==typeof e)return!1;if(null==e.length)return!1;for(let i=0;i<e.length;i++){const r=e[i];if("number"!=typeof r||r<0||r>=256||r%1)return!1}return!0}function c(e,r){if(r||(r={}),"number"==typeof e){n.checkSafeUint53(e,"invalid arrayify value");const r=[];for(;e;)r.unshift(255&e),e=parseInt(String(e/256));return 0===r.length&&r.push(0),d(new Uint8Array(r))}if(r.allowMissingPrefix&&"string"==typeof e&&"0x"!==e.substring(0,2)&&(e="0x"+e),o(e)&&(e=e.toHexString()),m(e)){let t=e.substring(2);t.length%2&&("left"===r.hexPad?t="0x0"+t.substring(2):"right"===r.hexPad?t+="0":n.throwArgumentError("hex data is odd-length","value",e));const o=[];for(let i=0;i<t.length;i+=2)o.push(parseInt(t.substring(i,i+2),16));return d(new Uint8Array(o))}return l(e)?d(new Uint8Array(e)):n.throwArgumentError("invalid arrayify value","value",e)}function f(e){const r=e.map((e=>c(e))),t=r.reduce(((e,r)=>e+r.length),0),n=new Uint8Array(t);return r.reduce(((e,object)=>(n.set(object,e),e+object.length)),0),d(n)}function h(e){let r=c(e);if(0===r.length)return r;let t=0;for(;t<r.length&&0===r[t];)t++;return t&&(r=r.slice(t)),r}function m(e,r){return!("string"!=typeof e||!e.match(/^0x[0-9A-Fa-f]*$/))&&(!r||e.length===2+2*r)}const v="0123456789abcdef";function E(e,r){if(r||(r={}),"number"==typeof e){n.checkSafeUint53(e,"invalid hexlify value");let r="";for(;e;)r=v[15&e]+r,e=Math.floor(e/16);return r.length?(r.length%2&&(r="0"+r),"0x"+r):"0x00"}if(r.allowMissingPrefix&&"string"==typeof e&&"0x"!==e.substring(0,2)&&(e="0x"+e),o(e))return e.toHexString();if(m(e))return e.length%2&&("left"===r.hexPad?e="0x0"+e.substring(2):"right"===r.hexPad?e+="0":n.throwArgumentError("hex data is odd-length","value",e)),e.toLowerCase();if(l(e)){let r="0x";for(let i=0;i<e.length;i++){let t=e[i];r+=v[(240&t)>>4]+v[15&t]}return r}return n.throwArgumentError("invalid hexlify value","value",e)}function I(data){if("string"!=typeof data)data=E(data);else if(!m(data)||data.length%2)return null;return(data.length-2)/2}function y(data,e,r){return"string"!=typeof data?data=E(data):(!m(data)||data.length%2)&&n.throwArgumentError("invalid hexData","value",data),e=2+2*e,null!=r?"0x"+data.substring(e,2+2*r):"0x"+data.substring(e)}function A(e,r){for("string"!=typeof e?e=E(e):m(e)||n.throwArgumentError("invalid hex string","value",e),e.length>2*r+2&&n.throwArgumentError("value out of range","value",arguments[1]);e.length<2*r+2;)e="0x0"+e.substring(2);return e}}}]);
//# sourceMappingURL=8d43a65.js.map